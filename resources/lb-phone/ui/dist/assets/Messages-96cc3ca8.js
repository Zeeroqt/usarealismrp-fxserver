var Ge=Object.defineProperty;var Oe=(t,n,d)=>n in t?Ge(t,n,{enumerable:!0,configurable:!0,writable:!0,value:d}):t[n]=d;var ne=(t,n,d)=>(Oe(t,typeof n!="symbol"?n+"":n,d),d);import{r as h,j as e,F as z,a as c}from"./jsx-runtime-55b9ff2c.js";import{f as k,u as _,H as B,J as Ie,K as ve,M as Ue,L as l,j as V,N as ye,m as De,O as Ne,Q as re,h as J,R as Pe,C as Y,e as Z,T as Le,U as Ae,V as he,q as F,W as ke,X as Se,Y as Re,b as H,Z as _e,_ as fe,$ as $e,a0 as Ve,a1 as le,g as Ye,p as je,a2 as xe,w as Fe,x as He,a3 as Xe,r as ie,v as Me,i as Q,a4 as qe,a5 as Be,a6 as Qe}from"./Phone-aba84f0c.js";import{r as Ee}from"./number-28525126.js";const ge=(t,n=25,d=7,f=360,r=120)=>new Promise((a,o)=>{let i=document.createElement("canvas");i.width=f,i.height=r;let u=i.getContext("2d");u.fillStyle="#000";let O=new AudioContext;t.arrayBuffer().then(P=>O.decodeAudioData(P)).then(P=>{let G=(i.width-(n-1)*d)/n,I=i.height/2,y=Math.floor(P.length/n),v=P.getChannelData(0);for(let C=0;C<n;C++){let T=1,D=.1;for(let w=0;w<y;w++){let M=v[C*y+w];M<T&&(T=M),M>D&&(D=M)}let L=(1+T)*I,R=(D-T)*I;u.beginPath(),u.moveTo(C*(G+d),L),u.lineTo(C*(G+d),L+R),u.lineTo(C*(G+d)+G,L+R),u.lineTo(C*(G+d)+G,L),u.closePath(),u.fill()}i.toBlob(C=>a({blob:C,base64:i.toDataURL()}))})});class We{constructor(){ne(this,"mute",()=>{this.recorder&&this.recorder.stream.getTracks().forEach(n=>n.enabled=!1)});ne(this,"unmute",()=>{this.recorder&&this.recorder.stream.getTracks().forEach(n=>n.enabled=!0)});this.recorder=null,this.chunks=[]}start(n){this.recorder=new MediaRecorder(n),this.recorder.ondataavailable=d=>this.chunks.push(d.data),this.chunks=[],this.recorder.start(),k("isTalking").then(d=>{d?this.unmute():this.mute()})}stop(){const{recorder:n,chunks:d}=this;return new Promise(f=>{n.onstop=()=>{const r=new Blob(d,{type:n.mimeType}),a=new Audio;a.src=URL.createObjectURL(r);let o={blob:r};ge(r).then(i=>{ge(r,60,7,960,200).then(u=>{o.waveform={message:i.blob,placeholder:u.base64},a.duration===1/0?(a.currentTime=Number.MAX_SAFE_INTEGER,a.ontimeupdate=()=>f({...o,duration:Math.floor(a.duration+.5)})):f({...o,duration:Math.floor(a.duration+.5)})})})},n.stop()})}}function Ke(){const{User:t,View:n,UnreadMessages:d}=h.useContext(W),f=_(H.Settings),r=_(H.PhoneNumber),[a,o]=t,[i,u]=n,[O,P]=d,G=_(Y.Emoji),[I,y]=h.useState(!1),[v,C]=h.useState(null),[T,D]=h.useState(!1),[L,R]=h.useState(!1),[w,M]=h.useState(0),[x,X]=h.useState(0),[E,S]=h.useState(!1),[A,b]=h.useState(!1),[g,N]=h.useState([]),[j,ee]=h.useState(null),te=h.useRef(null),[$,K]=h.useState({content:"",attachments:[]}),se=_(Z);h.useEffect(()=>{k("Messages",{action:"getMessages",page:0,id:a.id}).then(s=>{if(s&&s.length>0){N([...s.reverse()]);let m=document.querySelector(".message-container");m.scrollTop=m.scrollHeight}else S(!0)})},[]);const ae=h.useRef(!1),ce=()=>{if($.content.length>0||$.attachments.length>0||j){let s={sender:r,timestamp:Date.now(),id:a.id,content:$.content,attachments:$.attachments};if(f.airplaneMode)return N(m=>[...m,{...s,delivered:!1}]);if(j){if(ae.current)return;ae.current=!0,he("Image",j.waves.message).then(m=>{he("Audio",j.blob).then(p=>{s.content=`<!AUDIO-MESSAGE-IMAGE="${m}"-AUDIO="${p}"-DURATION="${j.duration}"!>`,k("Messages",{action:"sendMessage",number:a.number,content:s.content,id:a.id}).then(U=>{N(U?q=>[...q,s]:q=>[...q,{...s,delivered:!1}]),ae.current=!1,ee(null)})})});return}if(j)return;k("Messages",{action:"sendMessage",number:a.number,content:$.content,attachments:$.attachments,id:a.id}).then(m=>{m?(N(p=>[...p,s]),ee(null)):N(p=>[...p,{...s,delivered:!1}]),K({content:"",attachments:[]}),te.current&&(te.current.value=""),F.APPS.MESSAGES.messages.set(F.APPS.MESSAGES.messages.value.map(p=>p.id===a.id?{...p,timestamp:new Date,lastMessage:s.content}:p))})}},oe=s=>{if(!(!s&&s<=0)){if(s>(se.MaxTransferAmount??Number.MAX_SAFE_INTEGER))return console.log("cant send");Y.PopUp.set({title:l("APPS.MESSAGES.PAY.SEND_TITLE").format({amount:se.CurrencyFormat.replace("%s",s)}),description:l("APPS.MESSAGES.PAY.SEND_DESCRIPTION").format({amount:se.CurrencyFormat.replace("%s",s),name:a.name??V(a.number)}),buttons:[{title:l("APPS.MESSAGES.PAY.SEND_BUTTON_CANCEL")},{title:l("APPS.MESSAGES.PAY.SEND_BUTTON_SEND"),cb:()=>{k("Wallet",{action:"sendPayment",number:a.number,amount:s}).then(m=>{if(!m.success)return;let p={id:a.id,sender:r,content:`<!SENT-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};N(U=>[...U,p])})}}]})}},pe=s=>{if(!s&&s<=0)return;let m={sender:r,content:`<!REQUESTED-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};k("Messages",{action:"sendMessage",number:a.number,content:m.content,attachments:[]}).then(p=>{N(p?U=>[...U,m]:U=>[...U,{...m,delivered:!1}])})},de=()=>{Y.PopUp.set({title:l("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:l("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:l("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:l("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{k("Maps",{action:"getCurrentLocation"}).then(s=>{if(!s)return;let m={id:a.id,sender:r,content:`<!SENT-LOCATION-X=${Ee(s.x,2)}Y=${Ee(s.y,2)}!>`,attachments:[],timestamp:Date.now()};k("Messages",{action:"sendMessage",number:a.number,content:m.content,attachments:m.attachments,id:m.id}).then(p=>{N(p?U=>[...U,m]:U=>[...U,{...m,delivered:!1}])})})}}]})},be=()=>{if(E||A)return;let s=document.querySelector("#last");if(!s)return;!ke(s)&&(b(!0),k("Messages",{action:"getMessages",page:x+1,id:a.id}).then(p=>{p&&p.length>0?(N([...p.reverse(),...g]),b(!1)):S(!0)}),X(p=>p+1))};B("messages:newMessage",s=>{if(a.id!==s.id||f.airplaneMode)return;N(p=>[...p,{...s,timestamp:Date.now()}]);let m=document.querySelector(".message-container");m.scrollTop=m.scrollHeight}),B("messages:renameGroup",s=>{a.id===s.channelId&&(f.airplaneMode||o(m=>({...m,name:s.name})))}),B("messages:messageDeleted",s=>{s&&(f.airplaneMode||N(g.filter(m=>m.id!==s)))}),B("messages:removeMember",s=>{a.id===s.channelId&&(f.airplaneMode||s.number===r&&(u("userlist"),o(null)))});const Ce=Ie(s=>{let m=s.target;for(;!m.classList.contains("message");)m=m.parentElement;let p=m.getAttribute("data-id");if(!p)return;let U=g.find(q=>q.id===p);U&&U.sender===r&&(me(U.content)||we(U.content)||ue(U.content)||Y.ContextMenu.set({buttons:[{title:l("APPS.MESSAGES.DELETE"),color:"red",cb:()=>{k("Messages",{action:"deleteMessage",id:p}).then(q=>{})}}]}))}),we=s=>{if(s)return/<!SENT-PAYMENT-(\d*)!>/.test(s)?!0:!!/<!REQUESTED-PAYMENT-(\d*)!>/.test(s)},me=s=>{if(s)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(s)},ue=s=>{if(s)return s==="<!CALL-NO-ANSWER!>"},Te=s=>{if(s)return/<!AUDIO-MESSAGE-IMAGE="(.*)"-AUDIO="(.*)"-DURATION="(.*)"!>/.test(s)};return e(z,{children:c("div",{className:"animation-slide left",children:[c(ve,{children:[I&&e(st,{setShow:y,setShowUserInfo:C,sendLocation:de,setData:o,data:a}),v&&e(tt,{setShow:C,user:a!=null&&a.isGroup?v:a})]}),c("div",{className:"message-header",children:[c("div",{className:"back",onClick:()=>{u("userlist"),o(null),a.unread&&(k("Messages",{action:"markRead",id:a.id}),P(s=>s-1))},children:[e(Ue,{}),O>0&&e("span",{className:"back-title",children:O})]}),c("div",{className:"user",onClick:()=>{a.isGroup?y(!0):C(!0)},children:[a.isGroup?e("div",{className:"group-avatar",children:a.members.sort((s,m)=>s.avatar?1:-1).map((s,m)=>e("img",{src:s.avatar??"./assets/img/no-pfp.png",alt:""},m)).slice(0,5)}):e("img",{src:a.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:a.isGroup?a.name??`${a.members.length} ${l("APPS.MESSAGES.PEOPLE")}`:a.name??V(a.number)})]}),e(ye,{className:`facetime ${a.isGroup?"hidden":""}`,onClick:()=>{a.isGroup||De({number:a.number,videoCall:!0})}})]}),e("div",{className:"message-container",onScroll:be,style:L||T?{height:"48%"}:{},children:e("div",{className:"message-body",children:g.map((s,m)=>e(Je,{index:m,messages:g,message:s,longPressEvent:Ce,func:{isMissed:ue,isLocation:me,isVoiceMessage:Te,pay:oe}}))})}),e("div",{className:"attachments",children:$.attachments.map((s,m)=>c("div",{className:"attachment",children:[Ne(s)?e("video",{src:s,muted:!0,controls:!1,loop:!0,autoPlay:!0}):e("img",{src:s}),e(re,{onClick:()=>{K({...$,attachments:$.attachments.filter((p,U)=>U!==m)})}})]},m))}),c("div",{className:"message-bottom",style:L||T?{height:"18%"}:{},children:[e("div",{className:"upper",children:c("div",{className:"input","data-border":!j,children:[j?c("div",{className:"audio-message",children:[e(re,{onClick:()=>ee(null)}),e("div",{className:"audio-waves",children:e("img",{src:j.waves.placeholder})})]}):e(J,{placeholder:l("APPS.MESSAGES.PLACEHOLDER"),ref:te,value:$.content,onChange:s=>{K({content:s.target.value,attachments:$.attachments})},onKeyDown:s=>{s.key=="Enter"&&ce()}}),($.content.length>0||$.attachments.length>0||j)&&e("div",{className:"send",onClick:()=>ce(),children:e(Pe,{})})]})}),e("div",{className:"actions-wrapper",children:c("div",{className:"actions",children:[e("div",{className:"action",onClick:()=>{if(G)return Y.Emoji.reset();Y.Emoji.set({onSelect:s=>K(m=>({content:`${m.content}${s.emoji}`,attachments:m.attachments}))})},children:e("img",{src:"./assets/img/icons/messages/emoji.png"})}),e("div",{className:"action",onClick:()=>{var s,m,p;$.attachments.length<3&&Y.Gallery.set({includeVideos:!0,allowExternal:(p=(m=(s=Z)==null?void 0:s.value)==null?void 0:m.AllowExternal)==null?void 0:p.Messages,onSelect:U=>K({...$,attachments:[...$.attachments,U.src]})})},children:e("img",{src:"./assets/img/icons/messages/gallery.png"})}),!a.isGroup&&e("div",{className:"action black",onClick:()=>{D(!1),R(s=>!s)},children:"$"}),e("div",{className:"action",onClick:()=>de(),children:e(Le,{})}),e("div",{className:"action blue",onClick:()=>{R(!1),D(s=>!s)},children:e(Ae,{})})]})}),L&&e(ze,{paymentAmount:w,setPaymentAmount:M,pay:oe,request:pe}),T&&e(Ze,{onEnd:s=>{s&&(ee({src:URL.createObjectURL(s.blob),blob:s.blob,waves:s.waveform,duration:s.duration}),D(!1))}})]})]})})}const Je=({messages:t,message:n,index:d,longPressEvent:f,func:r})=>{var L,R;const{User:a}=h.useContext(W),o=_(H.PhoneNumber),[i]=a,u=_(Z);let O,P,G,I,y,v,C=d===0?"last":"",T=n.sender===o?"self":"other",D=((L=t[d+1])==null?void 0:L.sender)===o?"self":"other";if(t[d+1]?G=Math.abs(n.timestamp-t[d+1].timestamp)/36e5:D=void 0,i.isGroup)O=(R=i.members.find(w=>w.number===n.sender))==null?void 0:R.name,P=!t[d-1]||t[d-1].sender!==n.sender;else if(n.content)if(r.isMissed(n.content))if(T==="other")n.content=l("APPS.MESSAGES.MISSED_CALL").format({number:n.sender});else return null;else/<!SENT-PAYMENT-(\d*)!>/.test(n.content)?I={amount:n.content.match(/\d/g).join(""),request:!1}:/<!REQUESTED-PAYMENT-(\d*)!>/.test(n.content)&&(I={amount:n.content.match(/\d/g).join(""),request:!0});if(r.isLocation(n.content)){let w=n.content.match(/X=(-?\d*\.?\d*)Y/)[1],M=n.content.match(/Y=(-?\d*\.?\d*)!>/)[1];y={x:w,y:M}}return r.isVoiceMessage(n.content)&&(v={wave:n.content.match(/AUDIO-MESSAGE-IMAGE="([^"]+)"/)[1],src:n.content.match(/AUDIO="([^"]+)"/)[1],duration:n.content.match(/DURATION="([^"]+)"/)[1]}),c("div",{className:`message ${T}`,id:C,"data-id":n.id,...f,children:[P&&T=="other"&&e("div",{className:"user",children:O??V(n.sender)}),n.delivered===!1?c("div",{className:"content-wrapper",children:[I&&e("div",{className:"payment",children:u.CurrencyFormat.replace("%s",I.amount)}),e("div",{className:"content",children:Se(n.content)}),e(Re,{})]}):I||y||v?c(z,{children:[y&&c("div",{className:"location",onClick:()=>{H.App.set({name:"Maps",data:{location:[y.y,y.x],name:`${O??V(n.sender)}'s location`,icon:i.avatar}})},children:[e("div",{className:"img",style:{backgroundImage:'url("https://img.gta5-mods.com/q95/images/mirror-park-garden/2b72f9-20160428154103_1.jpg")'}}),T==="other"&&c("div",{className:"sender",children:[O??V(n.sender)," ",l("APPS.MESSAGES.SENT_LOCATION")]})]}),I&&e("div",{className:"payment",children:I.request?c("div",{className:`request ${T}`,children:[c("div",{className:"title",children:[u.CurrencyFormat.replace("%s",I.amount)," ",l("APPS.MESSAGES.PAY.REQUESTED")]}),T==="other"&&e("div",{className:"button",onClick:()=>r.pay(I.amount),children:l("APPS.MESSAGES.PAY.PAY")})]}):e("div",{className:"sent",children:u.CurrencyFormat.replace("%s",I.amount)})}),v&&e(et,{data:v,sender:T})]}):n.content&&e("div",{className:"content",children:Se(n.content)}),n.attachments&&n.attachments.length>0&&e("div",{className:"attatchments",children:n.attachments.map((w,M)=>Ne(w)?e("video",{src:w,controls:!1,loop:!0,autoPlay:!0,muted:!0,onClick:x=>{Y.FullscreenImage.set({display:!0,image:w})}},M):e(_e,{src:w,onClick:()=>{Y.FullscreenImage.set({display:!0,image:w})}},M))}),n.delivered===!1?e("div",{className:"status",children:l("APPS.MESSAGES.NOT_DELIVERED")}):t[d+1]&&G>6?e("div",{className:"date",children:fe(n.timestamp)}):T!==D&&e("div",{className:"date",children:fe(n.timestamp)})]},d)},Ze=({onEnd:t})=>{const[n,d]=h.useState(!1),f=h.useRef(null);return h.useEffect(()=>{f.current=new We},[]),B("camera:toggleMicrophone",r=>{f!=null&&f.current&&(r?f.current.unmute():f.current.mute())}),e("div",{className:"audioMessage-container",children:e("div",{className:"audioMessage-button","data-recording":n,onClick:()=>{var a;if(!((a=navigator.mediaDevices)!=null&&a.getUserMedia)||!(f!=null&&f.current))return console.log("No media devices found");let r=f.current;n?r.stop().then(o=>{t(o),d(i=>!i)}):navigator.mediaDevices.getUserMedia({audio:!0}).then(o=>{r.start(o),d(i=>!i)})},children:n?e(re,{}):e(Ae,{})})})},ze=({paymentAmount:t,setPaymentAmount:n,request:d,pay:f})=>{const r=_(Z);return c("div",{className:"payment-container",children:[c("div",{className:"payment-wrapper",children:[e("div",{className:"button",onClick:()=>t>0&&n(a=>a-1),children:"-"}),e("div",{className:"amount",children:e(J,{type:"number",value:t,onChange:a=>{a.target.value.match(/^[0-9]+$/)&&parseFloat(a.target.value)>0&&a.target.value<(r.MaxTransferAmount??Number.MAX_SAFE_INTEGER)?n(parseFloat(a.target.value)):n(0)}})}),e("div",{className:"button",onClick:()=>n(a=>a+1),children:"+"})]}),c("div",{className:"payment-buttons",children:[e("div",{className:"button",onClick:()=>d(t),children:l("APPS.MESSAGES.PAY.REQUEST")}),e("div",{className:"button",onClick:()=>f(t),children:l("APPS.MESSAGES.PAY.SEND")})]})]})},et=({data:t,sender:n})=>{var o;const[d,f]=h.useState(!1),r=h.useRef(null);h.useEffect(()=>{r.current&&(r.current.onended=()=>{f(!1)})},[r]);const a=i=>{i=Math.floor(i);const u=Math.floor(i/60),O=i-u*60;return`${u<10?"0"+u:u}:${O<10?"0"+O:O}`};return c("div",{className:`voice-message ${n}`,children:[e("a",{onClick:()=>{r.current&&(d?(r.current.pause(),r.current.currentTime=0):r.current.play(),f(i=>!i))},children:d?e($e,{}):e(Ve,{})}),e("div",{className:"wave",children:e("img",{src:t.wave,alt:"wave"})}),e("div",{className:"duration",children:a(d&&Math.floor(((o=r.current)==null?void 0:o.currentTime)+.5)!==0?r.current.currentTime:t.duration)}),e("audio",{ref:r,children:e("source",{src:t.src,type:"audio/mpeg"})})]})},tt=({user:t,setShow:n})=>c(le.div,{className:"info-panel",initial:{y:750,opacity:.75},animate:{y:0,opacity:1},exit:{y:750,opacity:.75},transition:{ease:"easeInOut"},children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>n(!1),children:l("APPS.MESSAGES.DONE")})}),c("div",{className:"info-panel-body",children:[c("div",{className:"info-panel-top",children:[t.avatar?e("div",{className:"profile-image bigger",style:{backgroundImage:`url(${t.avatar})`}}):t.name?e("div",{className:"profile-image bigger",children:Ye(t.name)}):e("img",{src:t.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:t.name??V(t.number)})]}),e("div",{className:"items",children:!t.company&&c(z,{children:[t.name&&e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>je(t.number),children:V(t.number)})}),e("div",{className:"info-section",children:t.name?e("div",{className:"item blue",onClick:()=>{Y.Share.set({type:"contact",data:{firstname:t.firstname,lastname:t.lastname,number:t.number,avatar:t.avatar}})},children:l("APPS.PHONE.CONTACTS.SHARE_CONTACT")}):e("div",{className:"item blue",onClick:()=>{H.App.set({name:"Phone",view:"newContact",data:t.number})},children:l("APPS.PHONE.CONTACTS.ADD_CONTACT")})})]})})]})]}),st=t=>{const{View:n}=h.useContext(W),[d,f]=n,[r,a]=h.useState(!1),[o,i]=h.useState(null);let u=t.data,O=!u.members.find(P=>P.isOwner);return c(z,{children:[e(ve,{children:r&&e(at,{setShow:a,members:u.members,id:u.id})}),c(le.div,{className:"info-panel",initial:{y:750,opacity:.75},animate:{y:0,opacity:1},exit:{y:750,opacity:.75},transition:{ease:"easeInOut"},children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>{o&&o!==""&&o!==u.name?k("Messages",{action:"renameGroup",id:u.id,name:o}).then(P=>{t.setShow(!1)}):t.setShow(!1)},children:l("APPS.MESSAGES.DONE")})}),c("div",{className:"info-panel-body",children:[c("div",{className:"info-panel-top",children:[e("div",{className:"group-avatar",children:u.members.sort((P,G)=>P.avatar?1:-1).slice(0,10).map(P=>e("img",{src:P.avatar??"./assets/img/no-pfp.png",alt:""}))}),c("div",{className:"members",children:[u.members.length," ",l("APPS.MESSAGES.MEMBERS")]})]}),c("div",{className:"items",children:[e("div",{className:"info-section",children:c("div",{className:"item blue",children:[e(xe,{className:"add"}),e(J,{defaultValue:u.name??"Group Name",onChange:P=>i(P.target.value)})]})}),c("div",{className:"info-section",children:[u.members.sort((P,G)=>P.name&&!G.name?-1:!P.name&&G.name?1:P.name<G.name?-1:P.name>G.name?1:0).map(P=>c("div",{className:"item",children:[O&&e(Fe,{className:"remove",onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:l("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({name:P.name??V(P.number)}),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{k("Messages",{action:"removeMember",number:P.number,id:u.id}).then(G=>{G&&(t.setData(I=>{let y=I;return y.members=y.members.filter(v=>v.number!==P.number),y}),t.setShow(!1))})}}]})}}),e("img",{src:P.avatar??"./assets/img/no-pfp.png",alt:""}),e("div",{className:"name",children:P.name??V(P.number)}),e(He,{className:"info",onClick:()=>{t.setShowUserInfo({...P})}})]})),c("div",{className:"item blue",onClick:()=>a(!0),children:[e(Xe,{className:"add"}),l("APPS.MESSAGES.ADD_MEMBER")]})]}),e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>t.sendLocation(),children:l("APPS.MESSAGES.SHARE_LOCATION")})}),e("div",{className:"info-section",onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.LEAVE_POPUP.TITLE"),description:l("APPS.MESSAGES.LEAVE_POPUP.TEXT"),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.LEAVE_POPUP.LEAVE"),color:"red",cb:()=>{k("Messages",{action:"leaveGroup",id:u.id}).then(P=>{if(!P)return ie("info","Failed to leave group, server didnt callback request");f("userlist"),t.setShow(!1)})}}]})},children:e("div",{className:"item red",children:l("APPS.MESSAGES.LEAVE_GROUP")})})]})]})]})]})},at=t=>{const n=_(H.PhoneNumber),[d,f]=h.useState(""),r=_(F.APPS.PHONE.contacts);let a=t.members;return c(le.div,{className:"add-member-container",initial:{y:750,opacity:.75},animate:{y:0,opacity:1},exit:{y:750,opacity:.75},transition:{ease:"easeInOut"},children:[c("div",{className:"add-member-header",children:[c("div",{className:"top",children:[e("span",{}),e("div",{className:"title",children:l("APPS.MESSAGES.ADD_MEMBER")}),e("div",{className:"button",onClick:()=>t.setShow(!1),children:l("APPS.MESSAGES.CANCEL")})]}),e(Me,{placeholder:l("APPS.MESSAGES.SEARCH"),onChange:o=>f(o.target.value)})]}),e("div",{className:"contacts",children:r.filter(o=>!o.company).sort((o,i)=>o.firstname&&!i.firstname?-1:!o.firstname&&i.firstname?1:o.firstname<i.firstname?-1:o.firstname>i.firstname?1:0).filter(o=>!a.find(i=>i.number===o.number)||o.number===n).filter(o=>{var i,u;return o.firstname.toLowerCase().includes(d.toLowerCase())||((u=(i=o==null?void 0:o.lastname)==null?void 0:i.toLowerCase())==null?void 0:u.includes(d.toLowerCase()))}).map(o=>{let i=Q(o.firstname,o.lastname);return c("div",{className:"contact",onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.ADD_POPUP.TITLE"),description:l("APPS.MESSAGES.ADD_POPUP.TEXT").format({name:i}),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.ADD_POPUP.ADD"),cb:()=>{k("Messages",{action:"addMember",number:o.number,id:t.id}).then(u=>{u&&t.setShow(!1)})}}]})},children:[e("img",{src:o.avatar??"./assets/img/no-pfp.png"}),c("div",{className:"user",children:[e("div",{className:"name",children:i}),e("div",{className:"number",children:V(o.number)})]})]})})})]})};function nt(){const{User:t,View:n,Newmessage:d,ImportedUser:f}=h.useContext(W),[r,a]=t,[o,i]=n,[u,O]=f,P=_(H.PhoneNumber),[G,I]=d,y=_(F.APPS.PHONE.contacts),[v,C]=h.useState([]),T=h.useRef(null),[D,L]=h.useState(""),[R,w]=h.useState([]),[M,x]=h.useState({content:"",attachments:[]});h.useEffect(()=>{u&&(C([u]),O(null))},[u]);const X=()=>{(M.content.length>0||M.attachments.length>0)&&(v.length>1?k("Messages",{action:"createGroup",members:v,content:M.content,attachments:M.attachments}).then(E=>{E&&(a({isGroup:!0,members:v,lastMessage:M.content,timestamp:Date.now(),id:E}),i("messages"),I(!1))}):k("Messages",{action:"sendMessage",number:v[0].number,content:M.content,attachments:M.attachments}).then(E=>{var S,A,b,g;if(E){let N={number:v[0].number,name:(S=v[0])!=null&&S.firstname?Q((A=v[0])==null?void 0:A.firstname,(b=v[0])==null?void 0:b.lastname):void 0,avatar:(g=v[0])==null?void 0:g.avatar};a({...N,lastMessage:M.content,timestamp:Date.now(),id:E}),F.APPS.MESSAGES.messages.set([{id:E,...N,lastMessage:M.content,timestamp:Date.now(),isGroup:!1},...F.APPS.MESSAGES.messages.value]),i("messages"),I(!1)}}))};return h.useEffect(()=>{if(D.length>0){if(y){const E=y.filter(S=>{let A=Q(S.firstname,S.lastname);return A&&A.toLowerCase().includes(D.toLowerCase())&&!S.company});w(E)}}else w([])},[D]),c("div",{className:"new-message-container",children:[c("div",{className:"new-message-header",children:[e("span",{}),e("div",{className:"title",children:l("APPS.MESSAGES.NEW_MESSAGE")}),e("div",{className:"button",onClick:()=>{v.length>0&&(M.content.length>0||M.attachments.length>0)?X():I(!1)},children:v.length>0&&(M.content.length>0||M.attachments.length>0)?l("APPS.MESSAGES.SEND"):l("APPS.MESSAGES.CANCEL")})]}),c("div",{className:"new-message-body",children:[c("div",{className:"new-message-search",children:[c("div",{className:"to",children:[l("APPS.MESSAGES.TO"),":"]}),e("div",{className:"contacts",children:v.map((E,S)=>{let A=Q(E.firstname,E.lastname),b=A!=="Unknown";return e("div",{className:`contact ${b?"green":"blue"}`,onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:l("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({NAME:A??V(E.number)}),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{let g=v.filter(N=>N.number!==E.number);C(g)}}]})},children:b?A:V(E.number)},S)})}),e(J,{type:"text",ref:T,onChange:E=>{if(L(E.target.value),E.target.value.length==P.length&&/^\d+$/g.test(E.target.value)){if(E.target.value===P)return;C([...v,{number:E.target.value}]),T.current.value="",L("")}},onKeyDown:E=>{var S;E.key=="Backspace"&&D.length==0?((S=v[v.length-1])==null?void 0:S.name)===void 0?(T.current.value=v[v.length-1].number,C(v.slice(0,v.length-1))):C(v.slice(0,-1)):E.key=="Tab"&&(E.preventDefault(),R.length==1&&(C([...v,R[0]]),T.current.value="",L("")))}})]}),e("div",{className:"search-results",children:R&&R.filter(E=>!v.find(S=>S.number==E.number)).map((E,S)=>{let A=Q(E.firstname,E.lastname);return c("div",{className:"contact",onClick:()=>{v.find(g=>g.number==E.number)||(C([...v,E]),T.current.value="",L(""))},children:[e("img",{src:E.avatar??"./assets/img/no-pfp.png"}),c("div",{className:"user",children:[e("div",{className:"name",children:A}),e("div",{className:"number",children:V(E.number)})]})]},S)})})]}),v.length>0&&R.length===0&&e("div",{className:"message-bottom absolute",children:e("div",{className:"upper",children:c("div",{className:"input",children:[e(J,{placeholder:l("APPS.MESSAGES.PLACEHOLDER"),value:M.content,onChange:E=>{x({content:E.target.value??"",attachments:M.attachments})},onKeyDown:E=>{E.key=="Enter"&&X()}}),(M.content.length>0||M.attachments.length>0)&&e("div",{className:"send",onClick:()=>X(),children:e(Pe,{})})]})})})]})}function rt(){const{User:t,View:n,Newmessage:d,UnreadMessages:f,ImportedUser:r}=h.useContext(W),a=_(H.PhoneNumber),o=_(H.Settings),i=_(H.App),[u,O]=t,[P,G]=n,[I,y]=r,[v,C]=d,[T,D]=f,L=_(F.APPS.PHONE.contacts),R=_(F.APPS.MESSAGES.messages),[w,M]=h.useState(""),[x,X]=h.useState([]);h.useEffect(()=>{R?(ie("info","Using cache for recent messages"),X(R),D(x.filter(S=>S.unread).length)):k("Messages",{action:"getRecentMessages"}).then(S=>{let A=S.map(b=>{if(b.isGroup)return b.members=b.members.filter(g=>g.number!==a).map(g=>{let N=L.find(j=>j.number===g.number);return{name:N&&N.firstname?Q(N==null?void 0:N.firstname,N==null?void 0:N.lastname):void 0,avatar:N==null?void 0:N.avatar,blocked:N==null?void 0:N.blocked,favorite:N==null?void 0:N.favorite,number:g.number,isOwner:g.isOwner}}),b;{let g=L.find(N=>N.number===b.number);return b.name=g!=null&&g.lastname?`${g.firstname} ${g.lastname}`:g==null?void 0:g.firstname,b.avatar=g==null?void 0:g.avatar,b}});D(A.filter(b=>b.unread).length),X(A),ie("info","setting cache"),F.APPS.MESSAGES.messages.set(A)})},[R]);let E=h.useRef(!1);return h.useEffect(()=>{if(!E.current&&i!=null&&i.data&&(E.current=!0,i!=null&&i.data&&i.view=="messages")){let S=x.find(A=>A.number===i.data.number);S?(O(S),G("messages")):(C(!0),y({number:i.data.number,firstname:i.data.firstname,lastname:i.data.lastname,avatar:i.data.avatar})),H.App.set({name:i.name})}},[i==null?void 0:i.data,x]),B("messages:newMessage",S=>{let A=JSON.parse(JSON.stringify(x)),b=A.findIndex(g=>g.id===S.id);o.airplaneMode||(b!==-1&&A.unshift(A.splice(b,1)[0]),A[0].lastMessage=S.content,A[0].timestamp=new Date,X(A))}),c(z,{children:[v&&e(nt,{}),c("div",{className:`animation-slide ${x.length>0?"right":""}`,children:[c("div",{className:"messages-header",children:[e("div",{className:"title",children:l("APPS.MESSAGES.TITLE")}),e(qe,{onClick:()=>C(!0)})]}),e(Me,{placeholder:l("SEARCH"),onChange:S=>M(S.target.value)}),e("div",{className:"users-list",children:x.filter(S=>{var A;return(S.isGroup?S.members.find(b=>{var g;return((g=b.name)==null?void 0:g.toLowerCase().includes(w.toLowerCase()))||b.number.includes(w)}):((A=S.name)==null?void 0:A.toLowerCase().includes(w.toLowerCase()))||S.number.includes(w))||S.lastMessage.toLowerCase().includes(w.toLowerCase())}).sort((S,A)=>A.timestamp-S.timestamp).map((S,A)=>e(it,{user:S,onClick:()=>{if(O(S),G("messages"),S.unread){k("Messages",{action:"markRead",id:S.id}),D(g=>g-1);let b=F.APPS.MESSAGES.messages.value;F.APPS.MESSAGES.messages.set(b.map(g=>(g.id===S.id&&(g.unread=!1),g)))}}},A))})]})]})}const it=({user:t,onClick:n})=>{const d=_(Z);let f;if(t.isGroup?t.name?f=t.name:f=t.members.sort((r,a)=>r.name&&!a.name?-1:!r.name&&a.name?1:r.name<a.name?-1:r.name>a.name?1:0).map((r,a)=>{if(a<2)return r.name?r.name:V(r.number);if(a===2)return`+${t.members.length-2} ${l("APPS.MESSAGES.OTHER").toLowerCase()}`}).join(" "):f=t.name,t.lastMessage==="Attachment"&&(t.lastMessage=l("APPS.MESSAGES.SENT_A_PHOTO")),/<!SENT-PAYMENT-(\d*)!>/.test(t.lastMessage)){let r=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${l("APPS.MESSAGES.SENT")} ${d.CurrencyFormat.replace("%s",r)}`}else if(/<!REQUESTED-PAYMENT-(\d*)!>/.test(t.lastMessage)){let r=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${l("APPS.MESSAGES.REQUESTED")} $${r}`}else if(/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t.lastMessage))t.lastMessage=`${l("APPS.MESSAGES.SENT_LOCATION_SHORT")}`;else if(t.lastMessage.startsWith('<!AUDIO-MESSAGE-IMAGE="'))t.lastMessage="sent an audio message";else if(t.lastMessage==="<!CALL-NO-ANSWER!>")t.lastMessage=`${V(t.number)} tried to call you`;else if(t.lastMessage==="")return;return c("div",{className:"user",onClick:()=>n(),children:[e("div",{className:`read${t.unread?" unread":""}`}),t.isGroup?e("div",{className:"avatar group",children:t.members.map((r,a)=>{if(a<=4)return r.avatar?e("div",{style:{backgroundImage:`url(${r.avatar})`}},a):r.name?e("div",{children:r.name.charAt(0)},a):e("div",{className:"unknown"},a)})}):e("img",{className:"avatar",src:t.avatar??"assets/img/no-pfp.png"}),c("div",{className:"user-body",children:[c("div",{className:"user-header",children:[e("div",{className:"name",children:f??V(t.number)}),c("div",{className:"right",children:[e("div",{className:"time",children:Be(t.timestamp)}),e(Qe,{})]})]}),e("div",{className:"content",children:t.lastMessage.length>40?t.lastMessage.substring(0,40)+"...":t.lastMessage})]})]})};const W=h.createContext(null);function mt(){const[t,n]=h.useState(null),[d,f]=h.useState("userlist"),[r,a]=h.useState(null),[o,i]=h.useState(0),[u,O]=h.useState(!1);return e("div",{className:"messages-container",children:e(W.Provider,{value:{User:[t,n],View:[d,f],Newmessage:[u,O],ImportedUser:[r,a],UnreadMessages:[o,i]},children:d=="userlist"?e(rt,{}):e(Ke,{})})})}export{W as MessagesContext,mt as default};
