import{r as s,a,j as e,F as J}from"./jsx-runtime-7cf68bf7.js";import{b as U,t as A,f,L as n,w as K,_ as G,a8 as Q,a9 as ee,a6 as te,c as H,W as ae,d as T,C as j,M as se,aa as W,Z as ie,ab as le,a2 as ne,j as b,Q as ce,ac as re,h as $,K as oe}from"./Phone-e1d97322.js";import"./number-28525126.js";function de(){const{Email:L,View:M,Mails:p,SelectedMail:S,ShowNewMail:E,LoggedIn:N,fetchAndSetMail:c}=s.useContext(y);U(H.Settings);const[i,u]=L,[o,h]=p,[t,P]=M,[d,r]=E,[I,m]=N,[v,C]=s.useState(""),[x,q]=s.useState(""),[_,R]=s.useState([]),[F,V]=s.useState(0),[B,k]=s.useState(!1),[X,D]=s.useState(!1);s.useEffect(()=>{if(A.APPS.MAIL.recentmails.value)return h(A.APPS.MAIL.recentmails.value);f("Mail",{action:"getMails",page:0}).then(l=>{l&&(h(l),A.APPS.MAIL.recentmails.set(l))})},[]),s.useEffect(()=>{const l=setTimeout(()=>C(x),500);return()=>clearTimeout(l)},[x]),s.useEffect(()=>{v.length>0?f("Mail",{action:"search",query:v,page:0}).then(l=>{l&&R(l)}):(R([]),V(0))},[v]);const Y=()=>{if(X||B)return;let l=document.querySelector("#last");if(!l)return;!ae(l)&&(v.length>0?(k(!0),f("Mail",{action:"search",query:v,page:F+1}).then(g=>{g&&g.length>0?(R([...o,..._]),k(!1)):D(!0)}),V(g=>g+1)):(k(!0),f("Mail",{action:"getMails",page:F+1}).then(g=>{g&&g.length>0?(h([...o,...g]),k(!1),g.length<10&&D(!0)):D(!0)}),V(g=>g+1)))},Z=()=>{f("AccountSwitcher",{action:"getAccounts",app:"Mail"}).then(l=>{var g;if(!l)return T("info","No accounts found");let O=(g=l==null?void 0:l.filter(w=>w!==i))==null?void 0:g.map(w=>({title:w,cb:()=>{f("AccountSwitcher",{action:"switch",app:"Mail",account:w}).then(()=>{f("Mail",{action:"isLoggedIn"}).then(z=>{z?(A.APPS.MAIL.address.set(w),A.APPS.MAIL.recentmails.set(null),u(w),P("refresh")):A.APPS.MAIL.address.set(null)})})}}));j.ContextMenu.set({buttons:[{title:i},...O,{title:"Add email",cb:()=>{m(!1),P("login")}},{title:"Sign out",color:"red",cb:()=>{j.PopUp.set({title:n("APPS.MAIL.SIGN_OUT_POPUP.TITLE"),description:n("APPS.MAIL.SIGN_OUT_POPUP.DESCRIPTION"),buttons:[{title:n("APPS.MAIL.SIGN_OUT_POPUP.CANCEL")},{title:n("APPS.MAIL.SIGN_OUT_POPUP.PROCEED"),color:"red",cb:()=>{f("Mail",{action:"logout"}).then(w=>{w!=null&&w.success&&(P("login"),m(!1),u(null),A.APPS.MAIL.address.reset())})}}]})}}]})})};return a("div",{className:"slide right",children:[e("div",{className:"mail-header",children:e("div",{className:"title",children:n("APPS.MAIL.TITLE")})}),e(K,{placeholder:n("SEARCH"),onChange:l=>q(l.target.value)}),e("div",{className:"mail-list",onScroll:Y,children:(v.length>0?_:o).map((l,O)=>{let g=O===o.length-1?"last":"";return a("div",{id:g,className:"mail",onClick:()=>c(l),children:[a("div",{className:"item-header",children:[a("div",{className:"user",children:[e("div",{className:"symbol","data-read":(l.read||l.sender===i)??!1}),e("div",{className:"sender",children:l.sender===i?a(J,{children:[n("APPS.MAIL.YOU"),a("span",{children:["- ",l.to]})]}):l.sender})]}),a("div",{className:"date",children:[e("div",{className:"time",children:G(l.timestamp)}),e(Q,{})]})]}),a("div",{className:"item-body",children:[e("div",{className:"subject",children:l.subject}),e("div",{className:"message",children:l.message.length>70?l.message.substring(0,70)+"...":l.message})]})]},O)})}),e("div",{className:"mail-footer",children:a("div",{className:"footer-wrapper",children:[e(ee,{onClick:()=>{Z()}}),a("div",{className:"text",children:[e("div",{className:"title",children:i}),a("div",{className:"count",children:[o.filter(l=>!l.read&&i!==l.sender).length," ",n("APPS.MAIL.UNREAD")]})]}),e(te,{onClick:()=>r(!0)})]})})]})}function me(){const{Email:L,View:M,SelectedMail:p,ShowNewMail:S}=s.useContext(y);U(H.Settings);const[E,N]=M,[c]=L,[i]=p,[u,o]=S,h=s.useRef(null);return s.useEffect(()=>{h.current.style.height=h.current.scrollHeight+"px"},[h]),a("div",{className:"slide left",children:[e("div",{className:"mail-header",children:a("div",{className:"left",onClick:()=>N("home"),children:[e(se,{}),n("APPS.MAIL.INBOX")]})}),a("div",{className:"mail-wrapper",children:[a("div",{className:"item-header",children:[a("div",{className:"user",children:[e("div",{className:"name",children:i.sender}),a("div",{className:"to",children:[a("span",{children:[n("APPS.MAIL.TO"),":"]})," ",i.to]})]}),e("div",{className:"date",children:G(i.timestamp)})]}),e("div",{className:"item subject",children:i.subject}),e("div",{className:"item message",children:e(W,{value:i.message,disabled:!0,ref:h})}),i.attachments&&i.attachments.length>0&&e("div",{className:"item attachments",children:i.attachments.map((t,P)=>e("div",{className:"attachment",onClick:()=>{j.FullscreenImage.set({display:!0,image:t})},children:e(ie,{src:t})},P))}),i.actions&&e("div",{className:"item actions",children:i.actions.map((t,P)=>e("div",{className:"action",onClick:()=>{f("Mail",{action:"action",id:i.id,data:t.data})},children:t.label},P))})]}),e("div",{className:"mail-footer",children:a("div",{className:"footer-wrapper",children:[e("span",{}),e(le,{onClick:()=>{o({id:null,sender:c,to:i.sender===c?i.to:i.sender,subject:`Re: ${i.subject}`,message:"",attachments:[],timestamp:Date.now()})}})]})})]})}function ue(){const{Email:L,Mails:M,ShowNewMail:p}=s.useContext(y),[S]=L,[E,N]=M,[c,i]=p,u=s.useRef(null),[o,h]=s.useState(!1),[t,P]=s.useState({to:"",subject:"",message:"",attachments:[]});s.useEffect(()=>{c&&typeof c=="object"&&P({...t,to:c==null?void 0:c.to,subject:c==null?void 0:c.subject})},[c]);const d=()=>{if(o){if(!t)return T("warning","Form is null");t.to===""||t.subject===""||t.message===""||f("Mail",{action:"sendMail",data:t}).then(r=>{if(!r)return;let I={...t,id:r,read:!0,sender:S,timestamp:Date.now()};if(N([I,...E]),!A.APPS.MAIL.recentmails.value)return;let m=A.APPS.MAIL.recentmails.value;m.length>=10&&m.pop(),m.unshift(I),A.APPS.MAIL.recentmails.set(m),i(null)})}};return s.useEffect(()=>{if(!t)return h(!1);const r=t.to.match(/^([\w.%+-]+)@([\w-]+\.)+([\w]{2,})$/i);t.to!==""&&r&&t.subject!==""&&t.message!==""&&S!==t.to?h(!0):h(!1)},[t]),a(ne.div,{className:"new-mail-container",initial:{opacity:0,y:"100%"},animate:{opacity:1,y:0},exit:{opacity:0,y:"100%"},transition:{duration:.3,ease:"easeInOut"},children:[a("div",{className:"mail-header",children:[e("div",{className:"cancel",onClick:()=>i(!1),children:n("APPS.MAIL.CANCEL")}),e("div",{className:"title",children:n("APPS.MAIL.NEW_MESSAGE")}),e("div",{className:"send","data-disabled":!o,onClick:()=>d(),children:n("APPS.MAIL.SEND")})]}),a("div",{className:"mail-options",children:[a("div",{className:"option",children:[a("div",{className:"title",children:[n("APPS.MAIL.TO"),":"]}),e(b,{className:"blue",maxLength:60,defaultValue:t==null?void 0:t.to,onChange:r=>{P({...t,to:r.target.value})}})]}),a("div",{className:"option",children:[a("div",{className:"title",children:[n("APPS.MAIL.FROM"),":"]}),e(b,{type:"text",value:S,disabled:!0})]}),a("div",{className:"option",children:[a("div",{className:"title",children:[n("APPS.MAIL.SUBJECT"),":"]}),e(b,{type:"text",maxLength:50,defaultValue:t==null?void 0:t.subject,onChange:r=>{P({...t,subject:r.target.value})}})]}),a("div",{className:"option textarea",children:[a("div",{className:"title",children:[n("APPS.MAIL.MESSAGE"),":"]}),e(W,{type:"text",ref:u,onChange:r=>{u.current.style.height="auto",u.current.style.height=u.current.scrollHeight+"px",P({...t,message:r.target.value})}}),e("div",{className:"attachments",children:t.attachments.map((r,I)=>a("div",{className:"attachment",children:[e("img",{src:r,onClick:()=>{j.FullscreenImage.set({display:!0,image:r})}},I),e(ce,{onClick:m=>{m.stopPropagation();const v=t==null?void 0:t.attachments;v.splice(I,1),P({...t,attachments:v})}})]},I))})]})]}),e("div",{className:"mail-footer",children:e("div",{className:"footer-wrapper",children:e(re,{onClick:()=>{var r,I,m;j.Gallery.set({onSelect:v=>P({...t,attachments:[...t.attachments,v.src]}),allowExternal:(m=(I=(r=$)==null?void 0:r.value)==null?void 0:I.AllowExternal)==null?void 0:m.Mail})}})})})]})}function he(){const{Email:L,View:M}=s.useContext(y),[p,S]=L,[E,N]=M,[c,i]=s.useState(null),[u,o]=s.useState({email:"",password:""}),h=()=>{i(null),f("Mail",{action:"login",data:u}).then(t=>{if(t&&t.success)S(u.email),A.APPS.MAIL.address.set(u.email),A.APPS.MAIL.recentmails.set(null),N("home");else if(t&&t.error)return i(t.error)})};return a("div",{className:"mail-form",children:[a("div",{className:"item",children:[e("div",{className:"title",children:n("APPS.MAIL.EMAIL")}),e("div",{className:"input",children:e(b,{type:"text",placeholder:"mail@domain.com",maxLength:50,onChange:t=>{o({...u,email:t.target.value})}})}),c==="Invalid address"&&e("div",{className:"error",children:n("APPS.MAIL.EMAIL_INVALID")})]}),a("div",{className:"item",children:[e("div",{className:"title",children:n("APPS.MAIL.PASSWORD")}),e("div",{className:"input",children:e(b,{type:"password",placeholder:"********",onChange:t=>{o({...u,password:t.target.value})}})}),c==="Invalid password"&&e("div",{className:"error",children:n("APPS.MAIL.WRONG_PASSWORD")})]}),e("div",{className:"button",onClick:()=>h(),children:n("APPS.MAIL.LOGIN")}),a("div",{className:"footer",children:[n("APPS.MAIL.NO_EMAIL")," ",e("span",{onClick:()=>N("signup"),children:n("APPS.MAIL.CREATE_ONE")})]})]})}function Ae(){var P;const{Email:L,View:M}=s.useContext(y),[p,S]=L,[E,N]=M,c=U($),[i,u]=s.useState(null),[o,h]=s.useState({email:"",password:""}),t=()=>{if(o.email===""||o.password==="")return T("warning","Email or password is empty");f("Mail",{action:"createMail",data:o}).then(d=>{if(!d)return T("warning","Mail response is null");if(d&&d.success){const r=`${o.email}@${c.EmailDomain}`;S(r),A.APPS.MAIL.address.set(r),A.APPS.MAIL.recentmails.set(null),N("home")}else if(d==null||d.error,d&&d.error){T("warning",d.error),u(d.error);return}})};return a("div",{className:"mail-form",children:[a("div",{className:"item",children:[e("div",{className:"title",children:n("APPS.MAIL.EMAIL")}),a("div",{className:"input",children:[e(b,{type:"text",placeholder:"email",maxLength:50-((P=c.EmailDomain)==null?void 0:P.length),onChange:d=>{d.target.value.match(/^[a-zA-Z0-9]+$/)&&h({...o,email:d.target.value})}}),a("div",{className:"suffix",children:["@",c.EmailDomain]})]}),i==="Address already exists"&&e("div",{className:"error",children:n("APPS.MAIL.EMAIL_EXISTS")})]}),a("div",{className:"item",children:[e("div",{className:"title",children:n("APPS.MAIL.PASSWORD")}),e("div",{className:"input",children:e(b,{type:"password",placeholder:"********",onChange:d=>{h({...o,password:d.target.value})}})})]}),e("div",{className:"button",onClick:()=>t(),children:n("APPS.MAIL.CREATE_MAIL")}),a("div",{className:"footer",children:[n("APPS.MAIL.ALREADY_HAVE")," ",e("span",{onClick:()=>N("login"),children:n("APPS.MAIL.LOGIN")})]})]})}const y=s.createContext(null);function ve(){const[L,M]=s.useState(null),[p,S]=s.useState("signup"),[E,N]=s.useState([]),[c,i]=s.useState(null),[u,o]=s.useState(null),[h,t]=s.useState(!1),[P,d]=s.useState(!0),r=m=>{m&&f("Mail",{action:"getMail",id:m.id}).then(v=>{if(!v)return;i(v),S("mail");let C=A.APPS.MAIL.recentmails.value;C=C==null?void 0:C.map(x=>(x.id===m.id&&(x.read=!0),x)),A.APPS.MAIL.recentmails.set(C)})},I={home:e(de,{}),mail:e(me,{}),signup:e(Ae,{}),login:e(he,{})};return s.useEffect(()=>{if(A.APPS.MAIL.address.value){M(A.APPS.MAIL.address.value),d(!1),S("home");return}f("Mail",{action:"isLoggedIn"}).then(m=>{m&&(M(m),S("home")),d(!1),A.APPS.MAIL.address.set(m)})},[]),s.useEffect(()=>{if(p==="refresh")return S("home")},[p]),e("div",{className:"mail-container",children:a(y.Provider,{value:{Email:[L,M],View:[p,S],Mails:[E,N],SelectedMail:[c,i],ShowNewMail:[u,o],LoggedIn:[h,t],fetchAndSetMail:r},children:[e(oe,{initial:!1,mode:"wait",children:u&&e(ue,{})}),I[p]]})})}export{y as MailContext,ve as default};
