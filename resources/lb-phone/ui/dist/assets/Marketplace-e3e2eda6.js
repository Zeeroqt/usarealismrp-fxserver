import{r as l,a as r,j as a}from"./jsx-runtime-7cf68bf7.js";import{b as N,f as v,u as W,w as j,L as s,ag as w,j as K,aa as V,C as R,h as I,W as $,E as H,X as q,c as T,ay as z}from"./Phone-e1d97322.js";import"./number-28525126.js";function Q(){var b;const i=N(T.Settings),L=N(T.PhoneNumber),[f,M]=l.useState(!1),[E,A]=l.useState([]),[C,g]=l.useState(!1),[e,m]=l.useState(null),[O,d]=l.useState(0),[S,n]=l.useState(!1),[P,h]=l.useState(!1),[p,U]=l.useState(""),[k,y]=l.useState(""),[_,D]=l.useState([]);l.useEffect(()=>{const t=setTimeout(()=>U(k),500);return()=>clearTimeout(t)},[k]),l.useEffect(()=>{p.length>0&&v("MarketPlace",{action:"search",query:p}).then(t=>{t&&D(t)})},[p]),l.useEffect(()=>{v("MarketPlace",{action:"getPosts",page:0}).then(t=>{t&&t.length>0?A(t):n(!0)}),v("isAdmin").then(t=>M(t))},[]);const x=()=>{var o,c;if(!(e!=null&&e.title)||!(e!=null&&e.description)||!(e!=null&&e.price)||((o=e==null?void 0:e.attachments)==null?void 0:o.length)===0){let u;switch(!0){case!(e!=null&&e.title):u=s("APPS.MARKETPLACE.ERROR_POPUP.NO_TITLE");break;case!(e!=null&&e.description):u=s("APPS.MARKETPLACE.ERROR_POPUP.NO_DESCRIPTION");break;case!(e!=null&&e.price):u=s("APPS.MARKETPLACE.ERROR_POPUP.NO_PRICE");break;case((c=e==null?void 0:e.attachments)==null?void 0:c.length)===0:u=s("APPS.MARKETPLACE.ERROR_POPUP.NO_ATTACHMENTS")}R.PopUp.set({title:s("APPS.MARKETPLACE.ERROR_POPUP.TITLE"),description:u,buttons:[{title:s("APPS.MARKETPLACE.ERROR_POPUP.OK")}]});return}let t={...e,number:L};v("MarketPlace",{action:"sendPost",data:t}).then(u=>{u&&(A([{...t,id:u,timestamp:new Date().getTime()},...E]),g(!1))})},X=t=>{t&&R.PopUp.set({title:s("APPS.MARKETPLACE.DELETE_POPUP.TITLE"),description:s("APPS.MARKETPLACE.DELETE_POPUP.TEXT"),buttons:[{title:s("APPS.MARKETPLACE.DELETE_POPUP.CANCEL")},{title:s("APPS.MARKETPLACE.DELETE_POPUP.PROCEED"),color:"red",cb:()=>{v("MarketPlace",{action:"deletePost",id:t}).then(o=>{o&&A(E.filter(c=>c.id!==t))})}}]})},F=()=>{if(S||P)return;let t=document.querySelector("#last");if(!t)return;!$(t)&&(h(!0),v("MarketPlace",{action:"getPosts",page:O+1}).then(c=>{c&&c.length>0?(A([...E,...c]),h(!1),c.length<15&&n(!0)):n(!0)}),d(c=>c+1))};return W("marketPlace:newPost",t=>{i.airplaneMode||A([t,...E])}),l.useEffect(()=>{m(null)},[C]),r("div",{className:"marketplace-container",children:[a("div",{className:"marketplace-header",children:a(j,{theme:"dark",placeholder:s("APPS.MARKETPLACE.SEARCH"),onChange:t=>y(t.target.value)})}),a("div",{className:"add",onClick:()=>g(!0),children:a(w,{})}),a("div",{className:"marketplace-wrapper",children:a("div",{className:"posts",onScroll:F,children:(p.length>0?_:E).map((t,o)=>{let c=o===E.length-1?"last":"";return a(B,{post:t,last:c,deletePost:X,isAdmin:f},o)})})}),C&&r("div",{className:"new-post-container",children:[r("div",{className:"new-post-header",children:[a("div",{className:"cancel",onClick:()=>g(!1),children:s("APPS.MARKETPLACE.CANCEL")}),a("div",{className:"title",children:s("APPS.MARKETPLACE.NEW_POST")}),a("div",{})]}),r("div",{className:"new-post-body",children:[r("div",{className:"item",children:[a("div",{className:"title",children:s("APPS.MARKETPLACE.TITLE")}),a(K,{type:"text",placeholder:"Title",maxLength:50,onChange:t=>m({...e,title:t.target.value})})]}),r("div",{className:"item",children:[a("div",{className:"title",children:s("APPS.MARKETPLACE.DESCRIPTION")}),a(V,{type:"text",placeholder:"Your post",maxLength:250,rows:5,onChange:t=>m({...e,description:t.target.value})})]}),a("div",{className:"item",children:r("div",{className:"images",children:[(e==null?void 0:e.attachments)&&e.attachments.length>0&&e.attachments.map((t,o)=>a("div",{className:"image",style:{backgroundImage:`url(${t})`},onClick:()=>{m({...e,attachments:e.attachments.filter((c,u)=>u!==o)})}},o)),(!(e!=null&&e.attachments)||((b=e==null?void 0:e.attachments)==null?void 0:b.length)<=3)&&a("div",{className:"image",onClick:()=>{var t,o,c;R.Gallery.set({allowExternal:(c=(o=(t=I)==null?void 0:t.value)==null?void 0:o.AllowExternal)==null?void 0:c.MarketPlace,onSelect:u=>m({...e,attachments:[...(e==null?void 0:e.attachments)??[],u.src]})})},children:a(w,{})})]})}),r("div",{className:"item",children:[a("div",{className:"title",children:s("APPS.MARKETPLACE.PRICE")}),a(K,{type:"number",placeholder:"0",onChange:t=>{if(!t.target.value.match(/^[0-9]*$/))return t.preventDefault();m({...e,price:parseFloat(t.target.value)})}})]}),a("div",{className:"button",onClick:()=>x(),children:s("APPS.MARKETPLACE.POST")})]})]})]})}const B=({post:i,last:L,deletePost:f,isAdmin:M})=>{const E=N(T.Settings),A=N(T.PhoneNumber),C=N(I),g=l.useRef(null),e=l.useRef(null),[m,O]=l.useState(0),d={pos:{startLeft:0,startX:0},onMouseDown:n=>{d.pos={startLeft:e.current.scrollLeft,startX:n.clientX},e.current.style.userSelect="none",document.addEventListener("mouseup",d.onMouseUp),document.addEventListener("mousemove",d.onMove)},onMove:n=>{const P=(n.clientX-d.pos.startX)/z(E.display.size);e.current.scrollLeft=d.pos.startLeft-P;const h=e.current.getBoundingClientRect();(h.left-5>n.clientX||n.clientX>h.right-5)&&d.onMouseUp()},onMouseUp:()=>{e.current.style.removeProperty("user-select"),document.removeEventListener("mouseup",d.onMouseUp),document.removeEventListener("mousemove",d.onMove);const n=i.attachments,P=e.current.clientWidth;let h=m;const p=e.current.scrollLeft-d.pos.startLeft;p>P/2&&h<n.length-1?h++:p<-P/2&&h>0&&h--,S(h)}},S=n=>{e.current.scrollTo({left:n*e.current.offsetWidth,behavior:"smooth"}),O(n)};return r("div",{className:"post",id:L,ref:g,children:[a("div",{className:"images",ref:e,onMouseDown:d.onMouseDown,children:i.attachments&&i.attachments.map((n,P)=>a("div",{className:"image",children:a("img",{src:n,onClick:()=>R.FullscreenImage.set(n)})},P))}),r("div",{className:"post-info",children:[r("div",{className:"post-header",children:[a("div",{className:"price",children:C.CurrencyFormat.replace("%s",i.price)}),i.attachments&&i.attachments.length>1&&a("div",{className:"scroll-dots",children:i.attachments.map((n,P)=>a("div",{className:`dot ${m==P&&"active"}`,onClick:()=>S(P)},P))})]}),r("div",{className:"post-content",children:[r("div",{className:"title",children:[i.title,r("div",{className:"date",children:["â€¢ ",H(i.timestamp)]})]}),a("div",{className:"description",children:q(i.description)}),r("div",{className:"buttons",children:[A!==i.number&&a("div",{className:"button",onClick:()=>{window.postMessage({data:{number:i.number,popUp:!0},action:"phone:contact"})},children:s("APPS.MARKETPLACE.CONTACT")}),(M||i.number===A)&&a("div",{className:"button red",onClick:()=>f(i.id),children:s("APPS.MARKETPLACE.REMOVE")})]})]})]})]})};export{Q as default};
