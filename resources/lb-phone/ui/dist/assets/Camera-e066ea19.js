import{r as n,j as s,F as J,a as p}from"./jsx-runtime-f40812bf.js";import{b as C,E as ue,aA as fe,f as o,u as Y,v as L,aB as Z,d as f,aC as me,c as H,C as V,aD as ge,aE as he,aF as pe,L as _,aG as ve,O as be,V as Ce,aH as Se,h as ye,S as F}from"./Phone-bbdfbfe1.js";import{r as Ae}from"./number-28525126.js";function we(){const R=C(ye),{Placement:ee}=n.useContext(ue),te=C(V.CameraComponent),k=C(F.Unlocked),ae=C(F.PassedFaceId),x=C(F.Visible),ne=C(F.LockScreenVisible),[Pe,S]=ee.PhoneRotation,[$,v]=n.useState(!1),[i,I]=n.useState("Photo"),[N,z]=n.useState(!1),[re,G]=n.useState(!1),[se,w]=n.useState(!1),[y,X]=n.useState(!1),[l,oe]=n.useState(!1),[W,K]=n.useState(0),[ie,O]=n.useState({}),U=n.useRef(null),D=n.useRef(null),b=n.useRef(null),c=n.useRef(null),m=n.useRef(null),u=["Video","Photo","Landscape"];n.useEffect(()=>{if(!b.current||c.current)return;let e=new fe(b.current);c.current=e},[b.current,x]),n.useEffect(()=>{var e;return(e=navigator.mediaDevices)==null||e.getUserMedia({audio:!0}).then(t=>{m.current=t}),()=>{c.current&&c.current.destroy(),te||o("Camera",{action:"close"})}},[]),Y("camera:usedCommand",e=>{switch(e){case"toggleTaking":M();break;case"toggleFlip":X(t=>!t);break;case"toggleFlash":z(t=>!t);break;case"leftMode":if(l)return;I(t=>{const a=u.indexOf(t);return a===0?u[u.length-1]:u[a-1]});break;case"rightMode":if(l)return;I(t=>{const a=u.indexOf(t);return a===u.length-1?u[0]:u[a+1]});break}}),n.useEffect(()=>{if(!D.current)return;let e=[];const a=setInterval(()=>{e.length>2&&(e=[]),e.push("."),D.current.innerText=_("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(a)},[$]);const E=(e,t)=>{if(t===void 0&&(t=be(e)),t){const a=document.createElement("video");a.src=e,a.muted=!0,a.play();const r=document.createElement("canvas");if(!r)return;a.addEventListener("loadeddata",()=>{r.width=a.videoWidth,r.height=a.videoHeight,r.getContext("2d").drawImage(a,0,0,r.width,r.height);const g=r.toDataURL("image/png");U.current.style.backgroundImage=`url(${g})`,L.APPS.CAMERA.lastImage.set(g),r.remove(),a.remove()})}else U.current.style.backgroundImage=`url(${e})`,L.APPS.CAMERA.lastImage.set(e)};n.useEffect(()=>{if(o("Camera",{action:x?"open":"close"}),ne||!k)o("toggleFlashlight",{toggled:!1}),S(0),I("Photo");else{if(o("Camera",{action:"flipCamera",value:y}),L.APPS.CAMERA.lastImage.value)return E(L.APPS.CAMERA.lastImage.value);o("Camera",{action:"getLastImage"}).then(e=>{e&&E(e)})}},[k,ae,x]),n.useEffect(()=>{if(l)return;switch(i){case"Landscape":O({marginRight:"9rem"}),S(90);break;case"Video":S(0),O({marginLeft:"12rem"});break;default:S(0),O({marginLeft:"3rem"});break}i==="Landscape"?c.current&&c.current.resizeByAspect(16/9):(i==="Video"||i==="Photo")&&c.current&&c.current.resizeByAspect(3/4),o("Camera",{action:"toggleLandscape",toggled:i==="Landscape"}),o("Camera",{action:"toggleVideo",toggled:i==="Video"});const e=window.innerWidth;e>1920&&c.current.setQuality(1920/e),i==="Photo"&&y?c.current.setXOffset(-.2):c.current.setXOffset(0)},[i]),n.useEffect(()=>{o("Camera",{action:"flipCamera",value:y}),!l&&(i=="Photo"&&y?c.current.setXOffset(-.2):c.current.setXOffset(0))},[k,y]);const Q=n.useRef(!0),q=async(e,t)=>{const a=Ae(e.size/1e3,2);return new Promise((r,g)=>{Ce(t?"Video":"Image",e).then(A=>{t?E(URL.createObjectURL(e),!0):E(A),f("info",`Saved ${t?"video":"photo"} to gallery (${a}kb) - ${A}`),Se(A,a).then(r),N&&o("toggleFlashlight",{toggled:!1}),r(!0)}).catch(g)})};Y("camera:toggleMicrophone",e=>{m.current&&(m.current.getAudioTracks()[0].enabled=e)}),n.useEffect(()=>{if(Q.current){Q.current=!1;return}if(N&&!l&&o("toggleFlashlight",{toggled:!1}),!l)return;const e=b.current.captureStream(24),t=new AudioContext,a=new MediaStreamAudioDestinationNode(t);if(m.current?(o("isTalking").then(P=>{m.current.getAudioTracks()[0].enabled=P}),t.createMediaStreamSource(m.current).connect(a)):t.createOscillator().connect(a),R.recordNearbyVoices){var r=R.ice?new Z({config:{iceTransportPolicy:"relay",iceServers:R.ice}}):new Z;r.on("open",h=>{o("Camera",{action:"setRecordingPeerId",peerId:h}),f("info","Listening for nearby voices")});const d=document.createElement("canvas");d.width=1,d.height=1;const P=d.captureStream(0);r.on("call",h=>{h.answer(P),h.on("stream",T=>{f("info","Received nearby voice");const j=new Audio;j.srcObject=T,j.volume=0,j.play(),new MediaStreamAudioSourceNode(t,{mediaStream:T}).connect(a)}),h.on("close",()=>{f("info","Stopped receiving nearby voice")})})}const g=[e.getVideoTracks()[0]];(m.current||R.recordNearbyVoices)&&g.unshift(a.stream.getAudioTracks()[0]);const A=new MediaStream(g),B=new MediaRecorder(A,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:2e6});let le=Date.now();B.ondataavailable=d=>{let P=Date.now()-le,h=new Blob([d.data],{type:"video/webm"});me(h,P,{logger:!1}).then(T=>{v(!0),t.close(),r&&(r.destroy(),f("info","Destroyed peer connection"),o("Camera",{action:"endedRecording"})),q(T,!0).then(()=>{v(!1)}).catch(()=>{v(!1),w(!0),setTimeout(()=>{w(!1)},1e4)})})},B.start();const de=setInterval(()=>{if(W>=60)return M();K(d=>d+1>=60?(M(),0):d+1)},1e3);return()=>{K(0),clearInterval(de),B.stop()}},[l]);const ce=e=>{let t=(e%60).toString(),a=(Math.floor(e/60)%60).toString(),r=Math.floor(e/3600).toString();return parseInt(r)<10&&(r="0"+r),parseInt(a)<10&&(a="0"+a),parseInt(t)<10&&(t="0"+t),r+":"+a+":"+t},M=()=>{if($)return f("info","Returning since an image is currently uploading");if(N&&o("toggleFlashlight",{toggled:!0}),i=="Video"){o("Camera",{action:"toggleHud",toggled:l}).then(()=>{oe(e=>!e)});return}o("Camera",{action:"toggleHud",toggled:!1}),setTimeout(()=>{var e,t;(t=(e=H.Settings.value)==null?void 0:e.sound)!=null&&t.silent||H.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),G(!0),V.IndicatorVisible.set(!1),setTimeout(()=>{G(!1),o("Camera",{action:"toggleHud",toggled:!0})},200),b.current.toBlob(a=>{v(!0),f("info","Uploading image, converting to blob"),q(a,!1).then(()=>{f("info","Image uploaded successfully"),v(!1),V.IndicatorVisible.set(!0)}).catch(r=>{v(!1),V.IndicatorVisible.set(!0),w(!0),setTimeout(()=>{w(!1)},1e4)})})},100)};return s(J,{children:p("div",{className:"camera-container",children:[p("div",{className:"camera-header",children:[s("div",{className:"flash",onClick:()=>z(e=>!e),children:!l&&N?s(ge,{}):s(he,{})}),i==="Video"&&p(J,{children:[s("div",{className:"timer",children:ce(W)}),s("span",{})]})]}),p("div",{className:`camera-body ${i=="Landscape"?"rotate":""}`,children:[s("canvas",{ref:b,style:{visibility:re?"hidden":"visible"}}),$&&p("div",{className:"loading",children:[s(pe,{size:80,speed:1,color:"#ffffff"}),s("div",{className:"uploading",ref:D,children:"Uploading..."})]}),se&&s("div",{className:"loading",children:s("div",{className:"uploading",children:"Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua"})})]}),p("div",{className:"camera-bottom",children:[s("div",{className:"camera-types",style:ie,children:u.map((e,t)=>s("div",{className:`${i===e&&"active"}`,onClick:()=>I(e),children:_(`APPS.CAMERA.${e.toUpperCase()}`)},t))}),p("div",{className:"camera-buttons",children:[s("div",{className:"image-gallery",ref:U,onClick:()=>{k&&(o("Camera",{action:"close"}),S(0),H.App.set({name:"Photos"}))}}),s("div",{className:"camera-button",onClick:()=>M(),children:s("div",{className:"camera-button-container",children:s("div",{className:`camera-button-inner ${i=="Video"&&`${i} ${l==!0&&"Recording"}`}`})})}),s("div",{className:"flip-camera",onClick:()=>{X(e=>!e)},children:s(ve,{})})]})]})]})})}export{we as default};
