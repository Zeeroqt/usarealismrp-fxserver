import{r,a as o,j as n,F as U}from"./jsx-runtime-7cf68bf7.js";import{b as M,j as h,f as d,L as s,aK as q,C as H,b_ as B,aB as J,aC as W,a as O,u as Z,bZ as z,b$ as Q,au as ee,E as y,x as te,bL as ne,bJ as ae,w as se}from"./PhoneProvider-fb5cb781.js";import{r as V}from"./number-28525126.js";function le(){const{Username:f,View:C,Channel:D}=r.useContext(k),[g,c]=D,[E,P]=C,[T]=f,[N,u]=r.useState(""),S=M(O.Settings),m=M(h.APPS.DARKCHAT.channels);return r.useEffect(()=>{h.APPS.DARKCHAT.channels.value||d("DarkChat",{action:"getChannels"}).then(t=>{t&&h.APPS.DARKCHAT.channels.set(t)})},[]),o("div",{className:"animation-slide right",children:[o("div",{className:"darkchat-header",children:[n("div",{className:"title",children:s("APPS.DARKCHAT.TITLE")}),n(q,{onClick:()=>{T&&H.PopUp.set({title:s("APPS.DARKCHAT.NEW_ROOM"),description:s("APPS.DARKCHAT.NEW_ROOM_TEXT"),input:{placeholder:s("APPS.DARKCHAT.ROOM_CODE"),type:"password",minCharacters:3,onChange:t=>u(t)},buttons:[{title:s("APPS.DARKCHAT.CANCEL")},{title:s("APPS.DARKCHAT.JOIN"),cb:()=>{u(t=>(d("DarkChat",{action:"joinChannel",name:t}).then(a=>{a&&(c({name:t}),P("chat"),h.APPS.DARKCHAT.channels.set([a,...m]))}),t))}}]})}})]}),n("div",{className:"channels-body",children:m==null?void 0:m.map((t,a)=>{const v=R=>{if(R)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(R)};return o("div",{className:"channel",onClick:()=>{T&&(c(t),P("chat"))},children:[o("div",{className:"channel-info",children:[o("div",{className:"channel-name",children:["#",S.streamerMode?"*****":t.name]}),o("div",{className:"recent-message",children:[o("div",{className:"members",children:[n(B,{}),o("span",{children:[t.members,":"]})]}),v(t.lastMessage)?s("APPS.MESSAGES.SENT_LOCATION_SHORT"):t.lastMessage]})]}),o("div",{className:"right",children:[n("div",{className:"timestamp",children:J(t.timestamp)}),n(W,{})]})]},a)})})]})}function re(){const{Username:f,View:C,Channel:D}=r.useContext(k),g=M(O.Settings),[c,E]=D,[P]=f,[T,N]=C,u=r.useRef(null),[S,m]=r.useState(""),[t,a]=r.useState([]),[v,R]=r.useState(0),[x,w]=r.useState(!1),[X,L]=r.useState(!1);r.useEffect(()=>{d("DarkChat",{action:"getMessages",page:0,channel:c.name}).then(e=>{e&&e.length>0?(a(e.reverse()),e.length<15&&w(!0)):w(!0)})},[]);const j=e=>{if(x||X)return;let l=document.querySelector("#last");if(!l)return;!se(l)&&(L(!0),d("DarkChat",{action:"getMessages",page:v+1,channel:c.name}).then(A=>{A&&A.length>0?(a([...A.reverse(),...t]),L(!1)):w(!0)}),R(A=>A+1))};r.useEffect(()=>{let e=document.querySelector(".chat-wrapper");e.scrollTop=e.scrollHeight},[t]);const I=()=>{if(S.length>0){let e={sender:P,content:S,timestamp:new Date().getTime()};d("DarkChat",{action:"sendMessage",content:S,channel:c.name}).then(()=>{m(""),u.current.value="",a([...t,e]);let l=h.APPS.DARKCHAT.channels.value.map(i=>(i.name===c.name&&(i.lastMessage=e.content,i.timestamp=new Date),i));h.APPS.DARKCHAT.channels.set(l)})}},F=()=>{H.PopUp.set({title:s("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:s("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:s("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:s("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{d("Maps",{action:"getCurrentLocation"}).then(e=>{if(!e)return;let l={content:`<!SENT-LOCATION-X=${V(e.x,2)}Y=${V(e.y,2)}!>`,sender:P,timestamp:new Date().getTime()};d("DarkChat",{action:"sendMessage",...l,channel:c.name}).then(i=>{if(i){a(p=>[...p,l]),m(""),u.current.value="";let A=h.APPS.DARKCHAT.channels.value.map(p=>(p.name===c.name&&(p.lastMessage=l.content,p.timestamp=new Date),p));h.APPS.DARKCHAT.channels.set(A)}else a(A=>[...A,{...l,delivered:!1}])})})}}]})};Z("darkChat:newMessage",e=>{if(c.name!==e.channel)return;let l=h.APPS.DARKCHAT.channels.value.map(i=>(i.name===e.channel&&(i.lastMessage=e.content,i.timestamp=new Date),i));h.APPS.DARKCHAT.channels.set(l),a([...t,{...e,timestamp:new Date().getTime()}])});const $=e=>{if(e)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(e)};return o("div",{className:"animation-slide left",children:[o("div",{className:"darkchat-header chat",children:[n(z,{onClick:()=>{N("channels"),E(null)}}),o("div",{className:"title",children:["#",g.streamerMode?"*****":c.name]}),n(Q,{onClick:()=>{H.PopUp.set({title:s("APPS.DARKCHAT.LEAVE_ROOM"),description:s("APPS.DARKCHAT.LEAVE_ROOM_TEXT"),buttons:[{title:s("APPS.DARKCHAT.CANCEL")},{title:s("APPS.DARKCHAT.LEAVE"),color:"red",cb:()=>{d("DarkChat",{action:"leaveChannel",channel:c.name}).then(e=>{if(e){N("channels"),E(null);let l=h.APPS.DARKCHAT.channels.value.filter(i=>i.name!==c.name);h.APPS.DARKCHAT.channels.set(l)}})}}]})}})]}),n("div",{className:"chat-wrapper",onScroll:j,children:n("div",{className:"chat-body",children:t.map((e,l)=>{var _;let i,A=null,p=l===0?"last":"",K=e.sender===P?"self":"other",b=((_=t[l+1])==null?void 0:_.sender)===P?"self":"other";if(t[l+1]?i=Math.abs(e.timestamp-t[l+1].timestamp)/36e5:b=void 0,$(e.content)){let G=e.content.match(/X=(-?\d*\.?\d*)Y/)[1],Y=e.content.match(/Y=(-?\d*\.?\d*)!>/)[1];A={x:G,y:Y}}return o("div",{className:`message ${K}`,id:p,children:[K=="other"&&n("div",{className:"user",children:e.sender}),A?n("div",{className:"location",onClick:()=>{O.App.set({name:"Maps",data:{location:[A.y,A.x],name:`${e.sender}'s location`}})},children:n("div",{className:"img",style:{backgroundImage:'url("https://img.gta5-mods.com/q95/images/mirror-park-garden/2b72f9-20160428154103_1.jpg")'}})}):n("div",{className:"content",children:ee(e.content)}),t[l+1]&&i>6?n("div",{className:"date",children:y(e.timestamp)}):K!==b&&n("div",{className:"date",children:y(e.timestamp)})]},l)})})}),o("div",{className:"chat-bottom",children:[n(te,{type:"text",placeholder:s("APPS.DARKCHAT.INPUT_PLACEHOLDER"),value:S,ref:u,onChange:e=>{m(e.target.value)},onKeyDown:e=>{if(e.key==="Enter")return I()}}),n(ne,{onClick:()=>F()}),n(ae,{onClick:()=>I()})]})]})}const k=r.createContext(null);function he(){const[f,C]=r.useState(null),[D,g]=r.useState(null),[c,E]=r.useState("channels"),[P,T]=r.useState(""),[N,u]=r.useState(!1),[S,m]=r.useState(!0);r.useEffect(()=>{if(h.APPS.DARKCHAT.username.value){C(h.APPS.DARKCHAT.username.value),m(!1);return}d("DarkChat",{action:"getUsername"}).then(a=>{m(!1),a&&(C(a),h.APPS.DARKCHAT.username.set(a))})},[]);const t={channels:n(le,{}),chat:n(re,{})};return n("div",{className:"darkchat-container",children:n(k.Provider,{value:{Username:[f,C],View:[c,E],Channel:[D,g]},children:!S&&o(U,{children:[!f&&!N&&o(U,{children:[u(!0),H.PopUp.set({title:s("APPS.DARKCHAT.USERNAME"),description:s("APPS.DARKCHAT.SET_USERNAME"),input:{placeholder:s("APPS.DARKCHAT.USERNAME"),type:"text",minCharacters:3,onChange:a=>T(a)},buttons:[{title:s("APPS.DARKCHAT.CANCEL"),cb:()=>O.App.reset()},{title:s("APPS.DARKCHAT.SET"),cb:()=>{T(a=>(d("DarkChat",{action:"setUsername",username:a}).then(v=>{if(!v)return u(!1);C(a)}),a))}}]})]}),t[c]]})})})}export{k as DarkChatContext,he as default};
