var Oe=Object.defineProperty;var Ue=(t,n,d)=>n in t?Oe(t,n,{enumerable:!0,configurable:!0,writable:!0,value:d}):t[n]=d;var Z=(t,n,d)=>(Ue(t,typeof n!="symbol"?n+"":n,d),d);import{r as h,j as e,F as te,a as c}from"./jsx-runtime-7cf68bf7.js";import{f as y,b as _,u as B,J as Ie,K as ve,M as De,L as l,m as V,N as ke,o as Le,O as Pe,Q as ie,j as z,R as Ae,C as Y,h as ee,T as ye,U as Me,V as Se,d as W,t as X,W as Re,X as fe,Y as _e,c as H,Z as $e,_ as Ee,a0 as Ve,a1 as Ye,a2 as le,a3 as ce,i as je,r as Fe,a4 as He,x as xe,y as Xe,a5 as qe,w as pe,k as Q,a6 as Be,a7 as Qe,a8 as We}from"./Phone-e1d97322.js";import{r as ge}from"./number-28525126.js";const Ne=(t,n=25,d=7,f=360,r=120)=>new Promise((a,o)=>{let i=document.createElement("canvas");i.width=f,i.height=r;let u=i.getContext("2d");u.fillStyle="#000";let O=new AudioContext;t.arrayBuffer().then(v=>O.decodeAudioData(v)).then(v=>{let G=(i.width-(n-1)*d)/n,U=i.height/2,D=Math.floor(v.length/n),N=v.getChannelData(0);for(let C=0;C<n;C++){let T=1,k=.1;for(let w=0;w<D;w++){let p=N[C*D+w];p<T&&(T=p),p>k&&(k=p)}let L=(1+T)*U,R=(k-T)*U;u.beginPath(),u.moveTo(C*(G+d),L),u.lineTo(C*(G+d),L+R),u.lineTo(C*(G+d)+G,L+R),u.lineTo(C*(G+d)+G,L),u.closePath(),u.fill()}i.toBlob(C=>a({blob:C,base64:i.toDataURL()}))})});class Ke{constructor(){Z(this,"recorder");Z(this,"chunks");Z(this,"mute",()=>{this.recorder&&this.recorder.stream.getTracks().forEach(n=>n.enabled=!1)});Z(this,"unmute",()=>{this.recorder&&this.recorder.stream.getTracks().forEach(n=>n.enabled=!0)});this.recorder=null,this.chunks=[]}start(n){this.recorder=new MediaRecorder(n),this.recorder.ondataavailable=d=>this.chunks.push(d.data),this.chunks=[],this.recorder.start(),y("isTalking").then(d=>{d?this.unmute():this.mute()})}stop(){const{recorder:n,chunks:d}=this;return new Promise(f=>{n.onstop=()=>{const r=new Blob(d,{type:n.mimeType}),a=new Audio;a.src=URL.createObjectURL(r);let o={blob:r};Ne(r).then(i=>{Ne(r,60,7,960,200).then(u=>{o.waveform={message:i.blob,placeholder:u.base64},a.duration===1/0?(a.currentTime=Number.MAX_SAFE_INTEGER,a.ontimeupdate=()=>f({...o,duration:Math.floor(a.duration+.5)})):f({...o,duration:Math.floor(a.duration+.5)})})})},n.stop()})}}function Je(){const{User:t,View:n,UnreadMessages:d}=h.useContext(K),f=_(H.Settings),r=_(H.PhoneNumber),[a,o]=t,[i,u]=n,[O,v]=d,G=_(Y.Emoji),[U,D]=h.useState(!1),[N,C]=h.useState(null),[T,k]=h.useState(!1),[L,R]=h.useState(!1),[w,p]=h.useState(0),[F,x]=h.useState(0),[E,S]=h.useState(!1),[A,b]=h.useState(!1),[g,P]=h.useState([]),[j,se]=h.useState(null),ae=h.useRef(null),[$,J]=h.useState({content:"",attachments:[]}),ne=_(ee);h.useEffect(()=>{y("Messages",{action:"getMessages",page:0,id:a.id}).then(s=>{if(s&&s.length>0){P([...s.reverse()]);let m=document.querySelector(".message-container");m.scrollTop=m.scrollHeight}else S(!0)})},[]);const re=h.useRef(!1),oe=()=>{if($.content.length>0||$.attachments.length>0||j){let s={sender:r,timestamp:Date.now(),id:a.id,content:$.content,attachments:$.attachments};if(f.airplaneMode)return P(m=>[...m,{...s,delivered:!1}]);if(j){if(re.current)return;re.current=!0,Se("Image",j.waves.message).then(m=>{Se("Audio",j.blob).then(M=>{s.content=`<!AUDIO-MESSAGE-IMAGE="${m}"-AUDIO="${M}"-DURATION="${j.duration}"!>`,y("Messages",{action:"sendMessage",number:a.number,content:s.content,id:a.id}).then(I=>{P(I?q=>[...q,s]:q=>[...q,{...s,delivered:!1}]),re.current=!1,se(null)})})});return}if(j)return;y("Messages",{action:"sendMessage",number:a.number,content:$.content,attachments:$.attachments,id:a.id}).then(m=>{m?(P(M=>[...M,s]),se(null)):P(M=>[...M,{...s,delivered:!1}]),J({content:"",attachments:[]}),ae.current&&(ae.current.value=""),W("info","Updating recent message cache state"),X.APPS.MESSAGES.messages.set(X.APPS.MESSAGES.messages.value.map(M=>M.id===a.id?{...M,timestamp:new Date,lastMessage:s.content}:M))})}},de=s=>{if(!(!s&&s<=0)){if(s>(ne.MaxTransferAmount??Number.MAX_SAFE_INTEGER))return W("error","Amount is too high");Y.PopUp.set({title:l("APPS.MESSAGES.PAY.SEND_TITLE").format({amount:ne.CurrencyFormat.replace("%s",s)}),description:l("APPS.MESSAGES.PAY.SEND_DESCRIPTION").format({amount:ne.CurrencyFormat.replace("%s",s),name:a.name??V(a.number)}),buttons:[{title:l("APPS.MESSAGES.PAY.SEND_BUTTON_CANCEL")},{title:l("APPS.MESSAGES.PAY.SEND_BUTTON_SEND"),cb:()=>{y("Wallet",{action:"sendPayment",number:a.number,amount:s}).then(m=>{if(!m.success)return;let M={id:a.id,sender:r,content:`<!SENT-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};P(I=>[...I,M])})}}]})}},be=s=>{if(!s&&s<=0)return;let m={sender:r,content:`<!REQUESTED-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};y("Messages",{action:"sendMessage",number:a.number,content:m.content,attachments:[]}).then(M=>{P(M?I=>[...I,m]:I=>[...I,{...m,delivered:!1}])})},me=()=>{Y.PopUp.set({title:l("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:l("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:l("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:l("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{y("Maps",{action:"getCurrentLocation"}).then(s=>{if(!s)return;let m={id:a.id,sender:r,content:`<!SENT-LOCATION-X=${ge(s.x,2)}Y=${ge(s.y,2)}!>`,attachments:[],timestamp:Date.now()};y("Messages",{action:"sendMessage",number:a.number,content:m.content,attachments:m.attachments,id:m.id}).then(M=>{P(M?I=>[...I,m]:I=>[...I,{...m,delivered:!1}])})})}}]})},Ce=()=>{if(E||A)return;let s=document.querySelector("#last");if(!s)return;!Re(s)&&(b(!0),y("Messages",{action:"getMessages",page:F+1,id:a.id}).then(M=>{M&&M.length>0?(P([...M.reverse(),...g]),b(!1)):S(!0)}),x(M=>M+1))};B("messages:newMessage",s=>{if(a.id!==s.id||f.airplaneMode)return;P(M=>[...M,{...s,timestamp:Date.now()}]);let m=document.querySelector(".message-container");m.scrollTop=m.scrollHeight}),B("messages:renameGroup",s=>{a.id===s.channelId&&(f.airplaneMode||o(m=>({...m,name:s.name})))}),B("messages:messageDeleted",s=>{s&&(f.airplaneMode||P(g.filter(m=>m.id!==s)))}),B("messages:removeMember",s=>{a.id===s.channelId&&(f.airplaneMode||s.number===r&&(u("userlist"),o(null)))});const we=Ie(s=>{let m=s.target;for(;!m.classList.contains("message");)m=m.parentElement;let M=m.getAttribute("data-id");if(!M)return;let I=g.find(q=>q.id===M);I&&I.sender===r&&(ue(I.content)||Te(I.content)||he(I.content)||Y.ContextMenu.set({buttons:[{title:l("APPS.MESSAGES.DELETE"),color:"red",cb:()=>{y("Messages",{action:"deleteMessage",id:M}).then(q=>{})}}]}))}),Te=s=>{if(s)return/<!SENT-PAYMENT-(\d*)!>/.test(s)?!0:!!/<!REQUESTED-PAYMENT-(\d*)!>/.test(s)},ue=s=>{if(s)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(s)},he=s=>{if(s)return s==="<!CALL-NO-ANSWER!>"},Ge=s=>{if(s)return/<!AUDIO-MESSAGE-IMAGE="(.*)"-AUDIO="(.*)"-DURATION="(.*)"!>/.test(s)};return e(te,{children:c("div",{className:"animation-slide left",children:[c(ve,{children:[U&&e(at,{setShow:D,setShowUserInfo:C,sendLocation:me,setData:o,data:a}),N&&e(st,{setShow:C,user:a!=null&&a.isGroup?N:a})]}),c("div",{className:"message-header",children:[c("div",{className:"back",onClick:()=>{u("userlist"),o(null),a.unread&&(y("Messages",{action:"markRead",id:a.id}),v(s=>s-1))},children:[e(De,{}),O>0&&e("span",{className:"back-title",children:O})]}),c("div",{className:"user",onClick:()=>{a.isGroup?D(!0):C(!0)},children:[a.isGroup?e("div",{className:"group-avatar",children:a.members.sort((s,m)=>s.avatar?1:-1).map((s,m)=>e("img",{src:s.avatar??"./assets/img/no-pfp.png",alt:""},m)).slice(0,5)}):e("img",{src:a.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:a.isGroup?a.name??`${a.members.length} ${l("APPS.MESSAGES.PEOPLE")}`:a.name??V(a.number)})]}),e(ke,{className:`facetime ${a.isGroup?"hidden":""}`,onClick:()=>{a.isGroup||Le({number:a.number,videoCall:!0})}})]}),e("div",{className:"message-container",onScroll:Ce,style:L||T?{height:"48%"}:{},children:e("div",{className:"message-body",children:g.map((s,m)=>e(Ze,{index:m,messages:g,message:s,longPressEvent:we,func:{isMissed:he,isLocation:ue,isVoiceMessage:Ge,pay:de}}))})}),e("div",{className:"attachments",children:$.attachments.map((s,m)=>c("div",{className:"attachment",children:[Pe(s)?e("video",{src:s,muted:!0,controls:!1,loop:!0,autoPlay:!0}):e("img",{src:s}),e(ie,{onClick:()=>{J({...$,attachments:$.attachments.filter((M,I)=>I!==m)})}})]},m))}),c("div",{className:"message-bottom",style:L||T?{height:"18%"}:{},children:[e("div",{className:"upper",children:c("div",{className:"input","data-border":!j,children:[j?c("div",{className:"audio-message",children:[e(ie,{onClick:()=>se(null)}),e("div",{className:"audio-waves",children:e("img",{src:j.waves.placeholder})})]}):e(z,{placeholder:l("APPS.MESSAGES.PLACEHOLDER"),ref:ae,value:$.content,onChange:s=>{J({content:s.target.value,attachments:$.attachments})},onKeyDown:s=>{s.key=="Enter"&&oe()}}),($.content.length>0||$.attachments.length>0||j)&&e("div",{className:"send",onClick:()=>oe(),children:e(Ae,{})})]})}),e("div",{className:"actions-wrapper",children:c("div",{className:"actions",children:[e("div",{className:"action",onClick:()=>{if(G)return Y.Emoji.reset();Y.Emoji.set({onSelect:s=>J(m=>({content:`${m.content}${s.emoji}`,attachments:m.attachments}))})},children:e("img",{src:"./assets/img/icons/messages/emoji.png"})}),e("div",{className:"action",onClick:()=>{var s,m,M;$.attachments.length<3&&Y.Gallery.set({includeVideos:!0,allowExternal:(M=(m=(s=ee)==null?void 0:s.value)==null?void 0:m.AllowExternal)==null?void 0:M.Messages,onSelect:I=>J({...$,attachments:[...$.attachments,I.src]})})},children:e("img",{src:"./assets/img/icons/messages/gallery.png"})}),!a.isGroup&&e("div",{className:"action black",onClick:()=>{k(!1),R(s=>!s)},children:"$"}),e("div",{className:"action",onClick:()=>me(),children:e(ye,{})}),e("div",{className:"action blue",onClick:()=>{R(!1),k(s=>!s)},children:e(Me,{})})]})}),L&&e(et,{paymentAmount:w,setPaymentAmount:p,pay:de,request:be}),T&&e(ze,{onEnd:s=>{s&&(se({src:URL.createObjectURL(s.blob),blob:s.blob,waves:s.waveform,duration:s.duration}),k(!1))}})]})]})})}const Ze=({messages:t,message:n,index:d,longPressEvent:f,func:r})=>{var L,R;const{User:a}=h.useContext(K),o=_(H.PhoneNumber),[i]=a,u=_(ee);let O,v,G,U,D,N,C=d===0?"last":"",T=n.sender===o?"self":"other",k=((L=t[d+1])==null?void 0:L.sender)===o?"self":"other";if(t[d+1]?G=Math.abs(n.timestamp-t[d+1].timestamp)/36e5:k=void 0,i.isGroup)O=(R=i.members.find(w=>w.number===n.sender))==null?void 0:R.name,v=!t[d-1]||t[d-1].sender!==n.sender;else if(n.content)if(r.isMissed(n.content))if(T==="other")n.content=l("APPS.MESSAGES.MISSED_CALL").format({number:n.sender});else return null;else/<!SENT-PAYMENT-(\d*)!>/.test(n.content)?U={amount:n.content.match(/\d/g).join(""),request:!1}:/<!REQUESTED-PAYMENT-(\d*)!>/.test(n.content)&&(U={amount:n.content.match(/\d/g).join(""),request:!0});if(r.isLocation(n.content)){let w=n.content.match(/X=(-?\d*\.?\d*)Y/)[1],p=n.content.match(/Y=(-?\d*\.?\d*)!>/)[1];D={x:w,y:p}}return r.isVoiceMessage(n.content)&&(N={wave:n.content.match(/AUDIO-MESSAGE-IMAGE="([^"]+)"/)[1],src:n.content.match(/AUDIO="([^"]+)"/)[1],duration:n.content.match(/DURATION="([^"]+)"/)[1]}),c("div",{className:`message ${T}`,id:C,"data-id":n.id,...f,children:[v&&T=="other"&&e("div",{className:"user",children:O??V(n.sender)}),n.delivered===!1?c("div",{className:"content-wrapper",children:[U&&e("div",{className:"payment",children:u.CurrencyFormat.replace("%s",U.amount)}),e("div",{className:"content",children:fe(n.content)}),e(_e,{})]}):U||D||N?c(te,{children:[D&&c("div",{className:"location",onClick:()=>{H.App.set({name:"Maps",data:{location:[D.y,D.x],name:`${O??V(n.sender)}'s location`,icon:i.avatar}})},children:[e("div",{className:"img",style:{backgroundImage:'url("https://img.gta5-mods.com/q95/images/mirror-park-garden/2b72f9-20160428154103_1.jpg")'}}),T==="other"&&c("div",{className:"sender",children:[O??V(n.sender)," ",l("APPS.MESSAGES.SENT_LOCATION")]})]}),U&&e("div",{className:"payment",children:U.request?c("div",{className:`request ${T}`,children:[c("div",{className:"title",children:[u.CurrencyFormat.replace("%s",U.amount)," ",l("APPS.MESSAGES.PAY.REQUESTED")]}),T==="other"&&e("div",{className:"button",onClick:()=>r.pay(U.amount),children:l("APPS.MESSAGES.PAY.PAY")})]}):e("div",{className:"sent",children:u.CurrencyFormat.replace("%s",U.amount)})}),N&&e(tt,{data:N,sender:T})]}):n.content&&e("div",{className:"content",children:fe(n.content)}),n.attachments&&n.attachments.length>0&&e("div",{className:"attatchments",children:n.attachments.map((w,p)=>Pe(w)?e("video",{src:w,controls:!1,loop:!0,autoPlay:!0,muted:!0,onClick:F=>{Y.FullscreenImage.set({display:!0,image:w})}},p):e($e,{src:w,onClick:()=>{Y.FullscreenImage.set({display:!0,image:w})}},p))}),n.delivered===!1?e("div",{className:"status",children:l("APPS.MESSAGES.NOT_DELIVERED")}):t[d+1]&&G>6?e("div",{className:"date",children:Ee(n.timestamp)}):T!==k&&e("div",{className:"date",children:Ee(n.timestamp)})]},d)},ze=({onEnd:t})=>{const[n,d]=h.useState(!1),f=h.useRef(null);return h.useEffect(()=>{f.current=new Ke},[]),B("camera:toggleMicrophone",r=>{f!=null&&f.current&&(r?f.current.unmute():f.current.mute())}),e("div",{className:"audioMessage-container",children:e("div",{className:"audioMessage-button","data-recording":n,onClick:()=>{var a;if(!((a=navigator.mediaDevices)!=null&&a.getUserMedia)||!(f!=null&&f.current))return W("error","No media devices found!");let r=f.current;n?r.stop().then(o=>{t(o),d(i=>!i)}):navigator.mediaDevices.getUserMedia({audio:!0}).then(o=>{r.start(o),d(i=>!i)})},children:n?e(ie,{}):e(Me,{})})})},et=({paymentAmount:t,setPaymentAmount:n,request:d,pay:f})=>{const r=_(ee);return c("div",{className:"payment-container",children:[c("div",{className:"payment-wrapper",children:[e("div",{className:"button",onClick:()=>t>0&&n(a=>a-1),children:"-"}),e("div",{className:"amount",children:e(z,{type:"number",value:t,onChange:a=>{a.target.value.match(/^[0-9]+$/)&&parseFloat(a.target.value)>0&&a.target.value<(r.MaxTransferAmount??Number.MAX_SAFE_INTEGER)?n(parseFloat(a.target.value)):n(0)}})}),e("div",{className:"button",onClick:()=>n(a=>a+1),children:"+"})]}),c("div",{className:"payment-buttons",children:[e("div",{className:"button",onClick:()=>d(t),children:l("APPS.MESSAGES.PAY.REQUEST")}),e("div",{className:"button",onClick:()=>f(t),children:l("APPS.MESSAGES.PAY.SEND")})]})]})},tt=({data:t,sender:n})=>{var o;const[d,f]=h.useState(!1),r=h.useRef(null);h.useEffect(()=>{r.current&&(r.current.onended=()=>{f(!1)})},[r]);const a=i=>{i=Math.floor(i);const u=Math.floor(i/60),O=i-u*60;return`${u<10?"0"+u:u}:${O<10?"0"+O:O}`};return c("div",{className:`voice-message ${n}`,children:[e("a",{onClick:()=>{r.current&&(d?(r.current.pause(),r.current.currentTime=0):r.current.play(),f(i=>!i))},children:d?e(Ve,{}):e(Ye,{})}),e("div",{className:"wave",children:e("img",{src:t.wave,alt:"wave"})}),e("div",{className:"duration",children:a(d&&Math.floor(((o=r.current)==null?void 0:o.currentTime)+.5)!==0?r.current.currentTime:t.duration)}),e("audio",{ref:r,children:e("source",{src:t.src,type:"audio/mpeg"})})]})},st=({user:t,setShow:n})=>c(le.div,{...ce,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>n(!1),children:l("APPS.MESSAGES.DONE")})}),c("div",{className:"info-panel-body",children:[c("div",{className:"info-panel-top",children:[t.avatar?e("div",{className:"profile-image bigger",style:{backgroundImage:`url(${t.avatar})`}}):t.name?e("div",{className:"profile-image bigger",children:je(t.name)}):e("img",{src:t.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:t.name??V(t.number)})]}),e("div",{className:"items",children:!t.company&&c(te,{children:[t.name&&e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>Fe(t.number),children:V(t.number)})}),e("div",{className:"info-section",children:t.name?e("div",{className:"item blue",onClick:()=>{Y.Share.set({type:"contact",data:{firstname:t.firstname,lastname:t.lastname,number:t.number,avatar:t.avatar}})},children:l("APPS.PHONE.CONTACTS.SHARE_CONTACT")}):e("div",{className:"item blue",onClick:()=>{H.App.set({name:"Phone",view:"newContact",data:t.number})},children:l("APPS.PHONE.CONTACTS.ADD_CONTACT")})})]})})]})]}),at=t=>{const{View:n}=h.useContext(K),[d,f]=n,[r,a]=h.useState(!1),[o,i]=h.useState(null);let u=t.data,O=!u.members.find(v=>v.isOwner);return c(te,{children:[e(ve,{children:r&&e(nt,{setShow:a,members:u.members,id:u.id})}),c(le.div,{...ce,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>{o&&o!==""&&o!==u.name?y("Messages",{action:"renameGroup",id:u.id,name:o}).then(v=>{t.setShow(!1)}):t.setShow(!1)},children:l("APPS.MESSAGES.DONE")})}),c("div",{className:"info-panel-body",children:[c("div",{className:"info-panel-top",children:[e("div",{className:"group-avatar",children:u.members.sort((v,G)=>v.avatar?1:-1).slice(0,10).map(v=>e("img",{src:v.avatar??"./assets/img/no-pfp.png",alt:""}))}),c("div",{className:"members",children:[u.members.length," ",l("APPS.MESSAGES.MEMBERS")]})]}),c("div",{className:"items",children:[e("div",{className:"info-section",children:c("div",{className:"item blue",children:[e(He,{className:"add"}),e(z,{defaultValue:u.name??"Group Name",onChange:v=>i(v.target.value)})]})}),c("div",{className:"info-section",children:[u.members.sort((v,G)=>v.name&&!G.name?-1:!v.name&&G.name?1:v.name<G.name?-1:v.name>G.name?1:0).map(v=>c("div",{className:"item",children:[O&&e(xe,{className:"remove",onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:l("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({name:v.name??V(v.number)}),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{y("Messages",{action:"removeMember",number:v.number,id:u.id}).then(G=>{G&&(t.setData(U=>{let D=U;return D.members=D.members.filter(N=>N.number!==v.number),D}),t.setShow(!1))})}}]})}}),e("img",{src:v.avatar??"./assets/img/no-pfp.png",alt:""}),e("div",{className:"name",children:v.name??V(v.number)}),e(Xe,{className:"info",onClick:()=>{t.setShowUserInfo({...v})}})]})),c("div",{className:"item blue",onClick:()=>a(!0),children:[e(qe,{className:"add"}),l("APPS.MESSAGES.ADD_MEMBER")]})]}),e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>t.sendLocation(),children:l("APPS.MESSAGES.SHARE_LOCATION")})}),e("div",{className:"info-section",onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.LEAVE_POPUP.TITLE"),description:l("APPS.MESSAGES.LEAVE_POPUP.TEXT"),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.LEAVE_POPUP.LEAVE"),color:"red",cb:()=>{y("Messages",{action:"leaveGroup",id:u.id}).then(v=>{if(!v)return W("info","Failed to leave group, server didnt callback request");f("userlist"),t.setShow(!1)})}}]})},children:e("div",{className:"item red",children:l("APPS.MESSAGES.LEAVE_GROUP")})})]})]})]})]})},nt=t=>{const n=_(H.PhoneNumber),[d,f]=h.useState(""),r=_(X.APPS.PHONE.contacts);let a=t.members;return c(le.div,{...ce,className:"add-member-container",children:[c("div",{className:"add-member-header",children:[c("div",{className:"top",children:[e("span",{}),e("div",{className:"title",children:l("APPS.MESSAGES.ADD_MEMBER")}),e("div",{className:"button",onClick:()=>t.setShow(!1),children:l("APPS.MESSAGES.CANCEL")})]}),e(pe,{placeholder:l("APPS.MESSAGES.SEARCH"),onChange:o=>f(o.target.value)})]}),e("div",{className:"contacts",children:r.filter(o=>!o.company).sort((o,i)=>o.firstname&&!i.firstname?-1:!o.firstname&&i.firstname?1:o.firstname<i.firstname?-1:o.firstname>i.firstname?1:0).filter(o=>!a.find(i=>i.number===o.number)||o.number===n).filter(o=>{var i,u;return o.firstname.toLowerCase().includes(d.toLowerCase())||((u=(i=o==null?void 0:o.lastname)==null?void 0:i.toLowerCase())==null?void 0:u.includes(d.toLowerCase()))}).map(o=>{let i=Q(o.firstname,o.lastname);return c("div",{className:"contact",onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.ADD_POPUP.TITLE"),description:l("APPS.MESSAGES.ADD_POPUP.TEXT").format({name:i}),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.ADD_POPUP.ADD"),cb:()=>{y("Messages",{action:"addMember",number:o.number,id:t.id}).then(u=>{u&&t.setShow(!1)})}}]})},children:[e("img",{src:o.avatar??"./assets/img/no-pfp.png"}),c("div",{className:"user",children:[e("div",{className:"name",children:i}),e("div",{className:"number",children:V(o.number)})]})]})})})]})};function rt(){const{User:t,View:n,Newmessage:d,ImportedUser:f}=h.useContext(K),[r,a]=t,[o,i]=n,[u,O]=f,v=_(H.PhoneNumber),[G,U]=d,D=_(X.APPS.PHONE.contacts),[N,C]=h.useState([]),T=h.useRef(null),[k,L]=h.useState(""),[R,w]=h.useState([]),[p,F]=h.useState({content:"",attachments:[]});h.useEffect(()=>{u&&(C([u]),O(null))},[u]);const x=()=>{(p.content.length>0||p.attachments.length>0)&&(N.length>1?y("Messages",{action:"createGroup",members:N,content:p.content,attachments:p.attachments}).then(E=>{E&&(a({isGroup:!0,members:N,lastMessage:p.content,timestamp:Date.now(),id:E}),i("messages"),U(!1))}):y("Messages",{action:"sendMessage",number:N[0].number,content:p.content,attachments:p.attachments}).then(E=>{var S,A,b,g;if(E){let P={number:N[0].number,name:(S=N[0])!=null&&S.firstname?Q((A=N[0])==null?void 0:A.firstname,(b=N[0])==null?void 0:b.lastname):void 0,avatar:(g=N[0])==null?void 0:g.avatar};a({...P,lastMessage:p.content,timestamp:Date.now(),id:E}),i("messages"),U(!1)}}))};return h.useEffect(()=>{if(k.length>0){if(D){const E=D.filter(S=>{let A=Q(S.firstname,S.lastname);return A&&A.toLowerCase().includes(k.toLowerCase())&&!S.company});w(E)}}else w([])},[k]),c("div",{className:"new-message-container",children:[c("div",{className:"new-message-header",children:[e("span",{}),e("div",{className:"title",children:l("APPS.MESSAGES.NEW_MESSAGE")}),e("div",{className:"button",onClick:()=>{N.length>0&&(p.content.length>0||p.attachments.length>0)?x():U(!1)},children:N.length>0&&(p.content.length>0||p.attachments.length>0)?l("APPS.MESSAGES.SEND"):l("APPS.MESSAGES.CANCEL")})]}),c("div",{className:"new-message-body",children:[c("div",{className:"new-message-search",children:[c("div",{className:"to",children:[l("APPS.MESSAGES.TO"),":"]}),e("div",{className:"contacts",children:N.map((E,S)=>{let A=Q(E.firstname,E.lastname),b=A!=="Unknown";return e("div",{className:`contact ${b?"green":"blue"}`,onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:l("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({NAME:A??V(E.number)}),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{let g=N.filter(P=>P.number!==E.number);C(g)}}]})},children:b?A:V(E.number)},S)})}),e(z,{type:"text",ref:T,onChange:E=>{if(L(E.target.value),E.target.value.length==v.length&&/^\d+$/g.test(E.target.value)){if(E.target.value===v)return;C([...N,{number:E.target.value}]),T.current.value="",L("")}},onKeyDown:E=>{var S;E.key=="Backspace"&&k.length==0?((S=N[N.length-1])==null?void 0:S.name)===void 0?(T.current.value=N[N.length-1].number,C(N.slice(0,N.length-1))):C(N.slice(0,-1)):E.key=="Tab"&&(E.preventDefault(),R.length==1&&(C([...N,R[0]]),T.current.value="",L("")))}})]}),e("div",{className:"search-results",children:R&&R.filter(E=>!N.find(S=>S.number==E.number)).map((E,S)=>{let A=Q(E.firstname,E.lastname);return c("div",{className:"contact",onClick:()=>{N.find(g=>g.number==E.number)||(C([...N,E]),T.current.value="",L(""))},children:[e("img",{src:E.avatar??"./assets/img/no-pfp.png"}),c("div",{className:"user",children:[e("div",{className:"name",children:A}),e("div",{className:"number",children:V(E.number)})]})]},S)})})]}),N.length>0&&R.length===0&&e("div",{className:"message-bottom absolute",children:e("div",{className:"upper",children:c("div",{className:"input",children:[e(z,{placeholder:l("APPS.MESSAGES.PLACEHOLDER"),value:p.content,onChange:E=>{F({content:E.target.value??"",attachments:p.attachments})},onKeyDown:E=>{E.key=="Enter"&&x()}}),(p.content.length>0||p.attachments.length>0)&&e("div",{className:"send",onClick:()=>x(),children:e(Ae,{})})]})})})]})}function it(){const{User:t,View:n,Newmessage:d,UnreadMessages:f,ImportedUser:r}=h.useContext(K),a=_(H.PhoneNumber),o=_(H.Settings),i=_(H.App),[u,O]=t,[v,G]=n,[U,D]=r,[N,C]=d,[T,k]=f,L=_(X.APPS.PHONE.contacts),R=_(X.APPS.MESSAGES.messages),[w,p]=h.useState(""),[F,x]=h.useState([]);h.useEffect(()=>{R?(W("info","Using cache for recent messages"),x(R),k(F.filter(S=>S.unread).length)):y("Messages",{action:"getRecentMessages"}).then(S=>{let A=S.map(b=>{if(b.isGroup)return b.members=b.members.filter(g=>g.number!==a).map(g=>{let P=L.find(j=>j.number===g.number);return{name:P&&P.firstname?Q(P==null?void 0:P.firstname,P==null?void 0:P.lastname):void 0,avatar:P==null?void 0:P.avatar,blocked:P==null?void 0:P.blocked,favorite:P==null?void 0:P.favorite,number:g.number,isOwner:g.isOwner}}),b;{let g=L.find(P=>P.number===b.number);return b.name=g!=null&&g.lastname?`${g.firstname} ${g.lastname}`:g==null?void 0:g.firstname,b.avatar=g==null?void 0:g.avatar,b}});k(A.filter(b=>b.unread).length),x(A),W("info","setting cache"),X.APPS.MESSAGES.messages.set(A)})},[R]);let E=h.useRef(!1);return h.useEffect(()=>{if(!E.current&&i!=null&&i.data&&(E.current=!0,i!=null&&i.data&&i.view=="messages")){let S=F.find(A=>A.number===i.data.number);S?(O(S),G("messages")):(C(!0),D({number:i.data.number,firstname:i.data.firstname,lastname:i.data.lastname,avatar:i.data.avatar})),H.App.set({name:i.name})}},[i==null?void 0:i.data,F]),B("messages:newMessage",S=>{let A=JSON.parse(JSON.stringify(F)),b=A.findIndex(g=>g.id===S.id);o.airplaneMode||(b!==-1&&A.unshift(A.splice(b,1)[0]),A[0].lastMessage=S.content,A[0].timestamp=new Date,x(A))}),c(te,{children:[N&&e(rt,{}),c("div",{className:`animation-slide ${F.length>0?"right":""}`,children:[c("div",{className:"messages-header",children:[e("div",{className:"title",children:l("APPS.MESSAGES.TITLE")}),e(Be,{onClick:()=>C(!0)})]}),e(pe,{placeholder:l("SEARCH"),onChange:S=>p(S.target.value)}),e("div",{className:"users-list",children:F.filter(S=>{var A;return(S.isGroup?S.members.find(b=>{var g;return((g=b.name)==null?void 0:g.toLowerCase().includes(w.toLowerCase()))||b.number.includes(w)}):((A=S.name)==null?void 0:A.toLowerCase().includes(w.toLowerCase()))||S.number.includes(w))||S.lastMessage.toLowerCase().includes(w.toLowerCase())}).sort((S,A)=>A.timestamp-S.timestamp).map((S,A)=>e(lt,{user:S,onClick:()=>{if(O(S),G("messages"),S.unread){y("Messages",{action:"markRead",id:S.id}),k(g=>g-1);let b=X.APPS.MESSAGES.messages.value;X.APPS.MESSAGES.messages.set(b.map(g=>(g.id===S.id&&(g.unread=!1),g)))}}},A))})]})]})}const lt=({user:t,onClick:n})=>{const d=_(ee);let f;if(t.isGroup?t.name?f=t.name:f=t.members.sort((r,a)=>r.name&&!a.name?-1:!r.name&&a.name?1:r.name<a.name?-1:r.name>a.name?1:0).map((r,a)=>{if(a<2)return r.name?r.name:V(r.number);if(a===2)return`+${t.members.length-2} ${l("APPS.MESSAGES.OTHER").toLowerCase()}`}).join(" "):f=t.name,t.lastMessage==="Attachment"&&(t.lastMessage=l("APPS.MESSAGES.SENT_A_PHOTO")),/<!SENT-PAYMENT-(\d*)!>/.test(t.lastMessage)){let r=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${l("APPS.MESSAGES.SENT")} ${d.CurrencyFormat.replace("%s",r)}`}else if(/<!REQUESTED-PAYMENT-(\d*)!>/.test(t.lastMessage)){let r=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${l("APPS.MESSAGES.REQUESTED")} $${r}`}else if(/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t.lastMessage))t.lastMessage=`${l("APPS.MESSAGES.SENT_LOCATION_SHORT")}`;else if(t.lastMessage.startsWith('<!AUDIO-MESSAGE-IMAGE="'))t.lastMessage="sent an audio message";else if(t.lastMessage==="<!CALL-NO-ANSWER!>")t.lastMessage=`${V(t.number)} tried to call you`;else if(t.lastMessage==="")return;return c("div",{className:"user",onClick:()=>n(),children:[e("div",{className:`read${t.unread?" unread":""}`}),t.isGroup?e("div",{className:"avatar group",children:t.members.map((r,a)=>{if(a<=4)return r.avatar?e("div",{style:{backgroundImage:`url(${r.avatar})`}},a):r.name?e("div",{children:r.name.charAt(0)},a):e("div",{className:"unknown"},a)})}):e("img",{className:"avatar",src:t.avatar??"assets/img/no-pfp.png"}),c("div",{className:"user-body",children:[c("div",{className:"user-header",children:[e("div",{className:"name",children:f??V(t.number)}),c("div",{className:"right",children:[e("div",{className:"time",children:Qe(t.timestamp)}),e(We,{})]})]}),e("div",{className:"content",children:t.lastMessage.length>40?t.lastMessage.substring(0,40)+"...":t.lastMessage})]})]})};const K=h.createContext(null);function ut(){const[t,n]=h.useState(null),[d,f]=h.useState("userlist"),[r,a]=h.useState(null),[o,i]=h.useState(0),[u,O]=h.useState(!1);return e("div",{className:"messages-container",children:e(K.Provider,{value:{User:[t,n],View:[d,f],Newmessage:[u,O],ImportedUser:[r,a],UnreadMessages:[o,i]},children:d=="userlist"?e(it,{}):e(Je,{})})})}export{K as MessagesContext,ut as default};
